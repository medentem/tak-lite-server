<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Social Media Monitoring - TAK Lite Admin</title>
    <style>
      :root { 
        --bg:#0b1220; 
        --panel:#111a2b; 
        --text:#e6edf3; 
        --muted:#8b97a7; 
        --accent:#3b82f6; 
        --ok:#22c55e; 
        --bad:#ef4444; 
        --warning:#f59e0b;
        --critical:#dc2626;
      }
      html,body { height:100%; }
      body { 
        margin:0; 
        background:linear-gradient(180deg,#0b1220,#0a0f1a); 
        color:var(--text); 
        font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; 
      }
      .container { max-width:none; margin:0 auto; padding:24px 16px; }
      #main-content { max-width: 1100px; margin-left: auto; margin-right: auto; }
      header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
      .brand { font-weight:700; letter-spacing:.3px; }
      .version-separator { 
        margin: 0 8px; 
        color: var(--muted); 
        font-weight: 400; 
      }
      .version-text { 
        font-size: 12px; 
        color: var(--muted); 
        font-weight: 400; 
        letter-spacing: 0.5px;
      }
      .card { background:var(--panel); border:1px solid #1f2a44; border-radius:12px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
      #main-content > .card { margin-bottom: 24px; }
      #main-content > .card:last-child { margin-bottom: 0; }
      .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:16px; }
      input,button,select,textarea { 
        height:40px; 
        border-radius:8px; 
        border:1px solid #233153; 
        background:#0c1527; 
        color:var(--text); 
        padding:0 12px; 
        font-size:14px;
      }
      textarea { 
        height:auto; 
        min-height:80px; 
        padding:12px; 
        resize:vertical;
      }
      input::placeholder, textarea::placeholder { color:#6b7280; }
      button { 
        background:linear-gradient(180deg,#2563eb,#1d4ed8); 
        border:0; 
        cursor:pointer; 
        font-weight:600; 
        transition:all 0.2s;
      }
      button:hover { transform:translateY(-1px); box-shadow:0 4px 12px rgba(37,99,235,0.3); }
      button.secondary { background:#0c1527; border:1px solid #223056; }
      button.danger { background:linear-gradient(180deg,#dc2626,#b91c1c); }
      button.success { background:linear-gradient(180deg,#22c55e,#16a34a); }
      .row { display:flex; gap:8px; align-items:center; }
      .section { margin-top:16px; }
      h2 { margin:0 0 8px; font-size:18px; color:#cbd5e1; }
      h3 { margin:0 0 12px; font-size:16px; color:#cbd5e1; }
      .kpi { 
        display:flex; 
        flex-direction: column; 
        align-items:center; 
        text-align: center; 
        gap:8px; 
        padding:20px;
        background:var(--panel);
        border-radius:12px;
        border:1px solid #1f2a44;
      }
      .kpi .value { font-size:32px; font-weight:700; color: var(--accent); line-height: 1; }
      .kpi .label { font-size:12px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; font-weight: 500; }
      table { width:100%; border-collapse:collapse; font-size:14px; }
      th, td { border-bottom:1px solid #1f2a44; padding:12px; text-align:left; }
      th { background:#0d1b34; font-weight:600; color:#cbd5e1; }
      .muted { color:var(--muted); }
      .pill { 
        padding:4px 12px; 
        border-radius:9999px; 
        background:#0d1b34; 
        border:1px solid #223056; 
        font-size:12px; 
        font-weight:500;
      }
      .pill.active { background:#22c55e; color:#000; }
      .pill.inactive { background:#ef4444; color:#fff; }
      .pill.critical { background:#dc2626; color:#fff; }
      .pill.high { background:#f59e0b; color:#000; }
      .pill.medium { background:#3b82f6; color:#fff; }
      .pill.low { background:#6b7280; color:#fff; }
      .pill.warning { background:var(--warning); color:#000; }
      .spacer { height:16px; }
      .right { text-align:right; }
      .hidden { display:none !important; }
      
      /* Tooltip styles */
      button[title]:hover::after {
        content: attr(title);
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        padding: 6px 10px;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        border-radius: 4px;
        font-size: 12px;
        white-space: nowrap;
        z-index: 1000;
        margin-bottom: 5px;
        pointer-events: none;
      }
      button[title] {
        position: relative;
      }
      .loading { 
        opacity:0.6; 
        pointer-events:none; 
        position: relative;
      }
      .loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 16px;
        height: 16px;
        margin: -8px 0 0 -8px;
        border: 2px solid transparent;
        border-top: 2px solid currentColor;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      /* Message styles matching admin page */
      .message { 
        padding: 12px; 
        border-radius: 6px; 
        margin: 12px 0; 
        font-weight: 500;
        transition: opacity 0.3s ease;
      }
      .message-success { background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); color: #22c55e; }
      .message-error { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444; }
      .message-info { background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); color: #3b82f6; }
      .message.fade-out { opacity: 0; }
      
      /* Modal styles */
      .modal { 
        position:fixed; 
        top:0; 
        left:0; 
        width:100%; 
        height:100%; 
        background:rgba(0,0,0,0.8); 
        display:flex; 
        align-items:center; 
        justify-content:center; 
        z-index:1000;
      }
      .modal-content { 
        background:var(--panel); 
        border:1px solid #1f2a44; 
        border-radius:12px; 
        padding:24px; 
        max-width:600px; 
        width:90%; 
        max-height:90vh; 
        overflow-y:auto;
      }
      .modal-header { 
        display:flex; 
        justify-content:space-between; 
        align-items:center; 
        margin-bottom:20px; 
        padding-bottom:16px; 
        border-bottom:1px solid #1f2a44;
      }
      .modal-header h3 { margin:0; }
      .close { 
        background:none; 
        border:none; 
        color:var(--muted); 
        font-size:24px; 
        cursor:pointer; 
        padding:0; 
        width:32px; 
        height:32px;
      }
      .form-group { margin-bottom:16px; }
      .form-group label { 
        display:block; 
        margin-bottom:8px; 
        font-weight:500; 
        color:#cbd5e1; 
      }
      .form-group input, .form-group select, .form-group textarea { 
        width:100%; 
        box-sizing:border-box; 
      }
      .checkbox-label {
        display: flex !important;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        margin-bottom: 0 !important;
      }
      .checkbox-label input[type="checkbox"] {
        width: auto !important;
        height: auto !important;
        margin: 0 !important;
        transform: scale(1.2);
      }
      .help-text { 
        background: #0d1b34; 
        border: 1px solid #223056; 
        border-radius: 6px; 
        padding: 12px; 
        margin-top: 8px; 
        font-size: 13px; 
        line-height: 1.4; 
        color: var(--muted);
      }
      .help-text strong { color: var(--text); }
      .form-actions { 
        display:flex; 
        gap:12px; 
        justify-content:flex-end; 
        margin-top:24px; 
        padding-top:16px; 
        border-top:1px solid #1f2a44;
      }
      
      
      /* Status indicators */
      .status-indicator { 
        width:8px; 
        height:8px; 
        border-radius:50%; 
        display:inline-block; 
        margin-right:8px;
        transition: all 0.3s ease;
      }
      .status-indicator.active { 
        background:var(--ok); 
        box-shadow: 0 0 8px rgba(34, 197, 94, 0.3);
      }
      .status-indicator.inactive { 
        background:var(--bad); 
        box-shadow: 0 0 8px rgba(239, 68, 68, 0.3);
      }
      .status-indicator.warning { 
        background:var(--warning); 
        box-shadow: 0 0 8px rgba(245, 158, 11, 0.3);
      }
      
      /* Responsive */
      @media (max-width: 768px) {
        .container { padding:16px; }
        .grid { grid-template-columns: 1fr; }
        .row { flex-direction:column; align-items:stretch; }
        .form-actions { flex-direction:column; }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <div class="brand">
          TAK Lite Admin
          <span class="version-separator">|</span>
          <span id="header_version" class="version-text">Social Media</span>
        </div>
        <div class="row">
          <button onclick="logout()" class="secondary">Logout</button>
        </div>
      </header>

      <!-- Navigation -->
      <nav style="margin-bottom: 20px;">
        <div class="card" style="padding: 12px 16px;">
          <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
            <a href="/admin" style="color: var(--muted); text-decoration: none; padding: 8px 12px; border-radius: 6px; transition: all 0.2s;">Dashboard</a>
            <a href="/admin#threats" style="color: var(--muted); text-decoration: none; padding: 8px 12px; border-radius: 6px; transition: all 0.2s;">Threat Review</a>
            <a href="/admin#messages" style="color: var(--muted); text-decoration: none; padding: 8px 12px; border-radius: 6px; transition: all 0.2s;">Messages</a>
            <a href="/admin#settings" style="color: var(--muted); text-decoration: none; padding: 8px 12px; border-radius: 6px; transition: all 0.2s;">Settings</a>
            <a href="/admin#management" style="color: var(--muted); text-decoration: none; padding: 8px 12px; border-radius: 6px; transition: all 0.2s;">Management</a>
            <a href="/social-media" style="color: var(--text); text-decoration: none; padding: 8px 12px; border-radius: 6px; background: var(--accent); font-weight: 500;">Social Media</a>
          </div>
        </div>
      </nav>

      <!-- Main Content -->
      <div id="main-content">
        <!-- Global message area -->
        <div id="globalMessage" class="message hidden"></div>
        
        <!-- Page Description -->
        <div class="card">
          <h2>Social Media Monitoring Setup</h2>
          <div class="help-text">
            <strong>Configure AI-powered threat detection</strong> for geographical areas using Grok AI with automatic health monitoring and recovery.<br>
            <strong>Features:</strong> Auto-start monitors, health monitoring, recovery mechanisms, and real-time status updates.<br>
            <strong>Note:</strong> Threat review and management is handled in the <a href="/admin" style="color: var(--accent);">Admin Dashboard</a>.
          </div>
        </div>
        
        <!-- Service Status Section -->
        <div class="card" style="border: 2px solid var(--accent); background: linear-gradient(180deg, var(--panel), #0d1b34);">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
            <div>
              <h2 style="margin:0 0 4px;">Service Status</h2>
              <div style="font-size:13px; color:var(--muted); margin-top:4px;">
                <strong>Master Control:</strong> The service must be enabled for monitors to run. When disabled, all monitors are stopped.
              </div>
            </div>
            <div style="display:flex; gap:12px; align-items:center;">
              <div id="service-status-indicator" class="status-indicator inactive"></div>
              <span id="service-status-text" style="font-weight:500;">Service Disabled</span>
              <button id="service-toggle-btn" onclick="toggleService()" class="success">Enable Service</button>
            </div>
          </div>
          
          <div id="service-status-details" class="grid" style="margin-bottom:20px;">
            <div class="kpi">
              <div class="value" id="service-active-monitors">0</div>
              <div class="label">Running Monitors</div>
            </div>
            <div class="kpi">
              <div class="value" id="service-total-monitors">0</div>
              <div class="label">Total Monitors</div>
            </div>
            <div class="kpi">
              <div class="value" id="service-posts-today">0</div>
              <div class="label">Posts Today</div>
            </div>
            <div class="kpi">
              <div class="value" id="service-health-status">Unknown</div>
              <div class="label">Health Status</div>
            </div>
          </div>
          
          <!-- Enhanced Service Status Details -->
          <div id="service-health-details" style="margin-bottom:20px; padding:16px; background:#0d1b34; border-radius:8px; border:1px solid #223056;">
            <h3 style="margin:0 0 12px; font-size:14px; color:#cbd5e1;">Service Health Monitoring</h3>
            <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:12px;">
              <div style="display:flex; align-items:center; gap:8px;">
                <div id="health-monitoring-indicator" class="status-indicator inactive"></div>
                <span style="font-size:12px; color:var(--muted);">Health Monitoring</span>
              </div>
              <div style="display:flex; align-items:center; gap:8px;">
                <div id="recovery-monitoring-indicator" class="status-indicator inactive"></div>
                <span style="font-size:12px; color:var(--muted);">Recovery Monitoring</span>
              </div>
              <div style="display:flex; align-items:center; gap:8px;">
                <div id="database-status-indicator" class="status-indicator inactive"></div>
                <span style="font-size:12px; color:var(--muted);">Database</span>
              </div>
              <div style="display:flex; align-items:center; gap:8px;">
                <div id="ai-service-indicator" class="status-indicator inactive"></div>
                <span style="font-size:12px; color:var(--muted);">AI Service</span>
              </div>
            </div>
          </div>
          
          <div style="display:flex; gap:12px; flex-wrap:wrap;">
            <button onclick="startAllMonitors()" class="secondary" id="start-all-btn" disabled title="Enable the service first to start monitors">Start All Monitors</button>
            <button onclick="stopAllMonitors()" class="danger" id="stop-all-btn" disabled title="Enable the service first to manage monitors">Stop All Monitors</button>
            <button onclick="showServiceConfigModal()" class="secondary">Service Settings</button>
            <button onclick="refreshServiceStatus()" class="secondary">Refresh Status</button>
            <button onclick="showServiceStatusModal()" class="secondary">Detailed Status</button>
          </div>
        </div>

        <!-- AI Usage & Cost Section -->
        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
            <div>
              <h2 style="margin:0 0 4px;">AI Usage & Cost</h2>
              <div style="font-size:13px; color:var(--muted); margin-top:4px;">
                Token usage and estimated cost for Grok API. Forecast is based on active monitors and their intervals.
              </div>
            </div>
            <button onclick="loadAIUsage()" class="secondary" title="Refresh usage">Refresh</button>
          </div>
          <div id="ai-usage-content" class="grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:16px;">
            <div class="kpi">
              <div class="value" id="usage-today-cost">$0.00</div>
              <div class="label">Cost Today</div>
            </div>
            <div class="kpi">
              <div class="value" id="usage-month-cost">$0.00</div>
              <div class="label">Cost This Month</div>
            </div>
            <div class="kpi">
              <div class="value" id="usage-today-tokens">0</div>
              <div class="label">Tokens Today</div>
            </div>
            <div class="kpi">
              <div class="value" id="usage-today-calls">0</div>
              <div class="label">API Calls Today</div>
            </div>
          </div>
          <div id="ai-usage-forecast" style="margin-top:16px; padding:12px; background:#0d1b34; border-radius:8px; border:1px solid #223056; font-size:13px;">
            <strong style="color:#cbd5e1;">Forecast:</strong>
            <span id="usage-forecast-text">—</span>
          </div>
          <div id="xai-account-section" style="margin-top:16px; padding:12px; background:#0d1b34; border-radius:8px; border:1px solid #223056; font-size:13px;">
            <strong style="color:#cbd5e1;">xAI account (actual)</strong>
            <div id="xai-account-content">
              <span id="xai-account-message">—</span>
            </div>
          </div>
        </div>

        <!-- Legacy monitor creation removed - use geographical monitoring instead -->

        <!-- Legacy monitors section removed - use geographical monitoring instead -->

        <!-- Geographical Monitoring Section -->
        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <div>
              <h2>Geographical Threat Monitoring</h2>
              <div style="font-size:13px; color:var(--muted); margin-top:4px;">
                Individual monitors that search for threats in specific geographical areas. <strong>Requires service to be enabled.</strong>
              </div>
            </div>
            <button onclick="showGeographicalMonitorModal()" class="secondary" id="add-monitor-btn">Add Geographical Monitor</button>
          </div>
          
          <div id="geographical-monitors-grid" class="grid">
            <!-- Geographical monitors will be loaded here -->
          </div>
        </div>

        <!-- AI Configuration Section -->
        <div class="card">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2>Grok AI Configuration</h2>
            <button onclick="showAIConfigModal()" class="secondary">Configure Grok AI</button>
          </div>
          
          <div id="ai-config-status">
            <!-- AI config status will be loaded here -->
          </div>
        </div>

      </div>
    </div>

    <!-- Legacy monitor modal removed - use geographical monitoring instead -->

    <!-- Geographical Monitor Modal -->
    <div id="geographical-monitor-modal" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Add Geographical Monitor</h3>
          <button class="close" onclick="closeModal()">&times;</button>
        </div>
        
        <form id="geographical-monitor-form">
          <div class="form-group">
            <label>Geographical Area</label>
            <input type="text" name="geographical_area" placeholder="e.g., Seattle, WA or Downtown Los Angeles" required>
            <div class="help-text">Specify the geographical area to monitor for threats</div>
          </div>
          
          <div class="form-group">
            <label>Search Query (Optional)</label>
            <input type="text" name="search_query" placeholder="e.g., violence, emergency, threat">
            <div class="help-text">Optional specific search terms to focus the threat detection</div>
          </div>
          
          <div class="form-group">
            <label>Monitoring Interval (seconds)</label>
            <input type="number" name="monitoring_interval" value="300" min="60" max="3600" id="monitor-interval-input">
            <div class="help-text">How often to search for new threats (60-3600 seconds)</div>
            <div id="monitor-interval-estimate" style="font-size:12px; color:var(--muted); margin-top:4px;">—</div>
          </div>
          
          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" name="is_active" checked> 
              <span>Active</span>
            </label>
          </div>
          
          <div class="form-actions">
            <button type="button" onclick="closeModal()" class="secondary">Cancel</button>
            <button type="submit" class="success">Create Monitor</button>
          </div>
        </form>
      </div>
    </div>

    <!-- AI Configuration Modal -->
    <div id="ai-config-modal" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Grok AI Configuration</h3>
          <button class="close" onclick="closeModal()">&times;</button>
        </div>
        
        <form id="ai-config-form">
          <div class="form-group">
            <label>Grok API Key</label>
            <input type="password" name="api_key_encrypted" placeholder="xai-..." required>
            <div class="help-text">
              Your xAI Grok API key for threat analysis and geographical search
              <br><strong>Note:</strong> The Grok API may not be publicly available yet. If you get a 404 error, the API is likely still in development.
            </div>
          </div>
          
          <div class="form-group">
            <label>AI Threat Search model</label>
            <select name="model">
              <option value="grok-4-1-fast-reasoning">Grok-4.1 Fast Reasoning (Recommended)</option>
              <option value="grok-4-1-fast-non-reasoning">Grok-4.1 Fast</option>
              <option value="grok-4-fast-reasoning">Grok-4 Fast Reasoning</option>
              <option value="grok-4-fast-non-reasoning">Grok-4 Fast</option>
              <option value="grok-3">Grok-3</option>
              <option value="grok-3-mini">Grok-3 Mini</option>
            </select>
            <div class="help-text">Model used for real-time geographical threat search. Use a capable model for best results.</div>
          </div>
          <div class="form-group">
            <label>AI Threat Deduplication model</label>
            <select name="deduplication_model">
              <option value="">Same as Search model</option>
              <option value="grok-4-1-fast-reasoning">Grok-4.1 Fast Reasoning</option>
              <option value="grok-4-1-fast-non-reasoning">Grok-4.1 Fast</option>
              <option value="grok-4-fast-reasoning">Grok-4 Fast Reasoning</option>
              <option value="grok-4-fast-non-reasoning">Grok-4 Fast</option>
              <option value="grok-3">Grok-3</option>
              <option value="grok-3-mini">Grok-3 Mini (cheaper)</option>
            </select>
            <div class="help-text">Model used to decide if a threat is new or a duplicate. A cheaper/faster model can reduce cost.</div>
          </div>
          
          <div class="form-actions">
            <button type="button" onclick="testAI()" class="secondary">Test AI</button>
            <button type="submit">Save Configuration</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Service Configuration Modal -->
    <div id="service-config-modal" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Service Configuration</h3>
          <button class="close" onclick="closeModal()">&times;</button>
        </div>
        
        <form id="service-config-form">
          <div class="form-group">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
              <input type="checkbox" name="auto_start_monitors" style="width: auto; margin: 0;">
              <span>Auto-start monitors when service is enabled</span>
            </label>
          </div>
          
          <div class="form-group">
            <label>Max Geographical Monitors</label>
            <input type="number" name="max_monitors_per_team" value="10" min="1" max="50">
            <div class="help-text">Maximum number of geographical monitors that can be active simultaneously</div>
          </div>
          
          <div class="form-group">
            <label>Default Monitoring Interval (seconds)</label>
            <input type="number" name="default_monitoring_interval" value="300" min="60" max="3600">
            <div class="help-text">Default interval for new monitors</div>
          </div>
          
          <div class="form-group">
            <label>Grok API Rate Limit (requests per hour)</label>
            <input type="number" name="max_posts_per_hour" value="100" min="10" max="1000">
            <div class="help-text">Maximum Grok API requests per hour to manage costs and rate limits</div>
          </div>
          
          <div class="form-actions">
            <button type="submit">Save Configuration</button>
          </div>
        </form>
      </div>
    </div>

    <!-- xAI Management API Key Modal (different from Grok API key) -->
    <div id="xai-management-modal" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3>xAI Management API Key</h3>
          <button class="close" onclick="closeModal()">&times;</button>
        </div>
        <div style="margin-bottom:16px; padding:12px; background:#1e293b; border-radius:8px; border:1px solid #334155; font-size:13px;">
          <strong>This is a different key from your Grok API key.</strong><br>
          The Grok API key is used for threat search. The Management API key is used only to <em>view</em> actual balance and usage from x.ai in this dashboard.<br>
          Get it from <strong>xAI Console → Settings → Management Keys</strong>. You also need your <strong>Team ID</strong> (from the Console URL or team settings).
        </div>
        <form id="xai-management-form">
          <div class="form-group">
            <label>Management API Key</label>
            <input type="password" name="management_api_key" placeholder="Your Management API key (not the Grok key)">
          </div>
          <div class="form-group">
            <label>Team ID</label>
            <input type="text" name="team_id" placeholder="Your xAI team ID">
          </div>
          <div class="form-actions">
            <button type="button" onclick="clearXaiManagementConfig()" class="secondary">Clear key</button>
            <button type="submit">Save</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Detailed Service Status Modal -->
    <div id="service-status-modal" class="modal hidden">
      <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
          <h3>Detailed Service Status</h3>
          <button class="close" onclick="closeModal()">&times;</button>
        </div>
        
        <div id="detailed-service-status">
          <!-- Detailed status will be loaded here -->
        </div>
        
        <div class="form-actions">
          <button onclick="refreshServiceStatus()" class="secondary">Refresh Status</button>
          <button onclick="closeModal()" class="secondary">Close</button>
        </div>
      </div>
    </div>

    <script>
      // Global state
      let geographicalMonitors = [];
      let aiConfig = null;
      let serviceStatus = null;
      let serviceConfig = null;
      let statusRefreshInterval = null;

      // Check authentication
      function checkAuth() {
        const token = localStorage.getItem('taklite:token');
        if (!token) {
          window.location.href = '/admin';
          return false;
        }
        return true;
      }

      // Logout function
      function logout() {
        localStorage.removeItem('taklite:token');
        window.location.href = '/admin';
      }

      // Initialize the page
      document.addEventListener('DOMContentLoaded', async function() {
        if (!checkAuth()) return;
        
        try {
          // Load all data in parallel
          await Promise.all([
            loadServiceStatus(),
            loadServiceConfig(),
            loadGeographicalMonitors(),
            loadAIConfig(),
            loadAIUsage()
          ]);
        } catch (error) {
          console.error('Failed to load page data:', error);
          // Show error but keep page visible
          showError('Some data failed to load: ' + error.message);
        }
        
        // Set up form handlers
        document.getElementById('geographical-monitor-form').addEventListener('submit', handleGeographicalMonitorSubmit);
        document.getElementById('ai-config-form').addEventListener('submit', handleAIConfigSubmit);
        document.getElementById('service-config-form').addEventListener('submit', handleServiceConfigSubmit);
        document.getElementById('xai-management-form').addEventListener('submit', handleXaiManagementSubmit);
        document.getElementById('monitor-interval-input')?.addEventListener('input', updateMonitorIntervalEstimate);
        
        // Start auto-refresh for service status
        startStatusAutoRefresh();
      });

      // API functions
      async function apiCall(endpoint, options = {}) {
        const token = localStorage.getItem('taklite:token');
        const response = await fetch(endpoint, {
          ...options,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`,
            ...options.headers
          }
        });
        
        if (!response.ok) {
          if (response.status === 401) {
            // Token expired or invalid, redirect to login
            localStorage.removeItem('taklite:token');
            window.location.href = '/admin';
            return;
          }
          const error = await response.json();
          throw new Error(error.error || 'API call failed');
        }
        
        return response.json();
      }

      // Load service status
      async function loadServiceStatus() {
        try {
          const data = await apiCall('/api/social-media/service/status');
          serviceStatus = data.status;
          renderServiceStatus();
        } catch (error) {
          console.error('Failed to load service status:', error);
          showError('Failed to load service status: ' + error.message);
        }
      }

      // Load detailed service status
      async function loadDetailedServiceStatus() {
        try {
          const data = await apiCall('/api/admin/service-status');
          return data;
        } catch (error) {
          console.error('Failed to load detailed service status:', error);
          return null;
        }
      }

      // Load service configuration
      async function loadServiceConfig() {
        try {
          const data = await apiCall('/api/social-media/service/config');
          serviceConfig = data.config;
        } catch (error) {
          console.error('Failed to load service config:', error);
        }
      }

      // Load AI usage and cost summary (includes xai_account when Management key is set)
      let aiUsageSummary = null;
      let xaiAccountData = null;
      async function loadAIUsage() {
        try {
          const data = await apiCall('/api/social-media/ai-usage');
          aiUsageSummary = data.usage;
          xaiAccountData = data.xai_account ?? { configured: false };
          renderAIUsage();
          renderXaiAccount();
        } catch (error) {
          console.error('Failed to load AI usage:', error);
          const el = document.getElementById('usage-forecast-text');
          if (el) el.textContent = 'Unable to load usage.';
          xaiAccountData = { configured: false };
          renderXaiAccount();
        }
      }

      function renderAIUsage() {
        if (!aiUsageSummary) return;
        const u = aiUsageSummary;
        const fmt = (n) => (typeof n === 'number' && !Number.isNaN(n) ? n.toFixed(4) : '0').replace(/\.?0+$/, '') || '0';
        const fmtCost = (c) => '$' + (typeof c === 'number' && !Number.isNaN(c) ? c.toFixed(2) : '0.00');
        document.getElementById('usage-today-cost').textContent = fmtCost(u.today.cost_usd);
        document.getElementById('usage-month-cost').textContent = fmtCost(u.month.cost_usd);
        document.getElementById('usage-today-tokens').textContent = (u.today.total_tokens || 0).toLocaleString();
        document.getElementById('usage-today-calls').textContent = (u.today.api_calls || 0).toLocaleString();
        const f = u.forecast;
        const forecastParts = [];
        forecastParts.push(`~${(f.daily_calls_at_current_setup || 0).toLocaleString()} API calls/day with ${f.active_monitors_in_forecast || 0} active monitor(s).`);
        if (f.cost_today_remaining_usd != null) forecastParts.push(`Est. remaining today: ${fmtCost(f.cost_today_remaining_usd)}.`);
        if (f.cost_month_forecast_usd != null) forecastParts.push(`Est. month total: ${fmtCost(f.cost_month_forecast_usd)}.`);
        document.getElementById('usage-forecast-text').textContent = forecastParts.join(' ') || '—';
      }

      function renderXaiAccount() {
        const content = document.getElementById('xai-account-content');
        if (!content) return;
        if (!xaiAccountData || !xaiAccountData.configured) {
          content.innerHTML = '<span id="xai-account-message">Add a Management API key to see actual balance and usage from x.ai.</span> <button onclick="showXaiManagementModal()" class="secondary" style="margin-left:8px;">Add Management Key</button>';
          return;
        }
        const parts = [];
        if (xaiAccountData.balance != null && typeof xaiAccountData.balance === 'object') {
          const b = xaiAccountData.balance;
          const amt = b.balance_usd ?? b.balance ?? b.credits;
          const cur = b.currency ?? 'USD';
          if (amt != null) parts.push('Balance: ' + (cur === 'USD' ? '$' : '') + Number(amt).toFixed(2) + (cur !== 'USD' ? ' ' + cur : ''));
        } else if (xaiAccountData.balance != null) {
          parts.push('Balance: ' + String(xaiAccountData.balance));
        }
        if (xaiAccountData.usage != null && typeof xaiAccountData.usage === 'object') {
          const u = xaiAccountData.usage;
          if (u.usage && Array.isArray(u.usage) && u.usage.length) {
            const total = u.usage.reduce((s, r) => s + (Number(r.cost_usd ?? r.cost ?? 0) || 0), 0);
            parts.push('Usage (x.ai): $' + total.toFixed(2));
          } else if (u.cost_usd != null) {
            parts.push('Usage: $' + Number(u.cost_usd).toFixed(2));
          }
        }
        if (xaiAccountData.team_id) parts.push('Team: ' + xaiAccountData.team_id);
        const text = parts.length ? parts.join(' · ') : 'Actual data loaded.';
        content.innerHTML = '<span id="xai-account-message">' + text + '</span> <button onclick="showXaiManagementModal()" class="secondary" style="margin-left:8px;">Manage key</button>';
      }

      function showXaiManagementModal() {
        document.getElementById('xai-management-modal').classList.remove('hidden');
        document.getElementById('xai-management-form').reset();
      }

      async function clearXaiManagementConfig() {
        try {
          await apiCall('/api/social-media/xai-management-config', { method: 'PUT', body: JSON.stringify({ management_api_key: '', team_id: '' }) });
          showSuccess('Management key cleared.');
          closeModal();
          document.getElementById('xai-management-modal').classList.add('hidden');
          xaiAccountData = { configured: false };
          renderXaiAccount();
          loadAIUsage();
        } catch (e) {
          showError('Failed to clear key: ' + e.message);
        }
      }

      // Render service status
      function renderServiceStatus() {
        if (!serviceStatus) return;

        const statusIndicator = document.getElementById('service-status-indicator');
        const statusText = document.getElementById('service-status-text');
        const toggleBtn = document.getElementById('service-toggle-btn');
        const startAllBtn = document.getElementById('start-all-btn');
        const stopAllBtn = document.getElementById('stop-all-btn');

        // Update status indicator and text
        if (serviceStatus.service_enabled) {
          statusIndicator.className = 'status-indicator active';
          statusText.textContent = 'Service Enabled';
          toggleBtn.textContent = 'Disable Service';
          toggleBtn.className = 'danger';
          startAllBtn.disabled = false;
          startAllBtn.title = 'Start all configured monitors';
          stopAllBtn.disabled = false;
          stopAllBtn.title = 'Stop all running monitors';
          serviceEnabled = true;
        } else {
          statusIndicator.className = 'status-indicator inactive';
          statusText.textContent = 'Service Disabled';
          toggleBtn.textContent = 'Enable Service';
          toggleBtn.className = 'success';
          startAllBtn.disabled = true;
          startAllBtn.title = 'Enable the service first to start monitors';
          stopAllBtn.disabled = true;
          stopAllBtn.title = 'Enable the service first to manage monitors';
          serviceEnabled = false;
        }

        // Update service metrics
        document.getElementById('service-active-monitors').textContent = serviceStatus.active_monitors;
        document.getElementById('service-total-monitors').textContent = serviceStatus.total_monitors;
        document.getElementById('service-posts-today').textContent = serviceStatus.posts_processed_today;
        
        // Update health status
        const healthStatus = serviceStatus.health_status || 'Unknown';
        document.getElementById('service-health-status').textContent = healthStatus;
        
        // Update health monitoring indicators
        updateHealthIndicators(serviceStatus);
        
        // Reload monitors to update their status based on service state
        if (geographicalMonitors) {
          loadGeographicalMonitors();
        }
      }

      // Update health monitoring indicators
      function updateHealthIndicators(status) {
        // Health monitoring status
        const healthMonitoringIndicator = document.getElementById('health-monitoring-indicator');
        if (status.health_monitoring) {
          healthMonitoringIndicator.className = 'status-indicator active';
        } else {
          healthMonitoringIndicator.className = 'status-indicator inactive';
        }

        // Recovery monitoring status
        const recoveryMonitoringIndicator = document.getElementById('recovery-monitoring-indicator');
        if (status.recovery_monitoring) {
          recoveryMonitoringIndicator.className = 'status-indicator active';
        } else {
          recoveryMonitoringIndicator.className = 'status-indicator inactive';
        }

        // Database status
        const databaseStatusIndicator = document.getElementById('database-status-indicator');
        if (status.database_connected) {
          databaseStatusIndicator.className = 'status-indicator active';
        } else {
          databaseStatusIndicator.className = 'status-indicator inactive';
        }

        // AI service status
        const aiServiceIndicator = document.getElementById('ai-service-indicator');
        if (status.ai_service_available) {
          aiServiceIndicator.className = 'status-indicator active';
        } else {
          aiServiceIndicator.className = 'status-indicator inactive';
        }
      }

      // Legacy monitor functions removed - use geographical monitoring instead

      // Global state for service enabled status
      let serviceEnabled = false;

      // Load geographical monitors
      async function loadGeographicalMonitors() {
        try {
          const data = await apiCall('/api/social-media/geographical-monitors');
          geographicalMonitors = data.monitors;
          serviceEnabled = data.service_enabled || false;
          renderGeographicalMonitors();
        } catch (error) {
          console.error('Failed to load geographical monitors:', error);
          showError('Failed to load geographical monitors: ' + error.message);
        }
      }

      // Render geographical monitors
      function renderGeographicalMonitors() {
        const grid = document.getElementById('geographical-monitors-grid');
        
        if (!geographicalMonitors || geographicalMonitors.length === 0) {
          grid.innerHTML = '<div style="text-align:center; color:var(--muted); padding:40px;">No geographical monitors configured</div>';
          return;
        }

        grid.innerHTML = geographicalMonitors.map(monitor => {
          // Determine status
          let statusText, statusClass, statusColor;
          let isBlocked = false;
          
          if (!serviceEnabled) {
            statusText = 'Blocked';
            statusClass = 'warning';
            statusColor = 'var(--warning)';
            isBlocked = true;
          } else if (monitor.is_running) {
            statusText = 'Running';
            statusClass = 'active';
            statusColor = 'var(--ok)';
          } else if (monitor.is_active) {
            statusText = 'Stopped';
            statusClass = 'inactive';
            statusColor = 'var(--muted)';
          } else {
            statusText = 'Stopped';
            statusClass = 'inactive';
            statusColor = 'var(--muted)';
          }

          // Determine button state and tooltip
          const canStart = serviceEnabled && !monitor.is_running;
          const canStop = serviceEnabled && monitor.is_running;
          const buttonDisabled = !canStart && !canStop;
          const buttonText = monitor.is_running ? 'Stop' : 'Start';
          const buttonClass = monitor.is_running ? 'danger' : 'success';
          const tooltip = isBlocked 
            ? 'Service must be enabled to start this monitor'
            : (monitor.is_running ? 'Stop this monitor' : 'Start this monitor');

          return `
          <div class="card" style="padding:16px; ${isBlocked ? 'opacity: 0.7;' : ''}">
            <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:12px;">
              <div style="flex:1;">
                <h4 style="margin:0 0 4px; color:#cbd5e1;">${monitor.geographical_area}</h4>
                ${monitor.search_query ? `<div style="font-size:12px; color:var(--muted); margin-top:2px;">Query: ${monitor.search_query}</div>` : ''}
              </div>
              <span class="pill ${statusClass}" style="background: ${statusColor}; color: ${statusClass === 'active' ? '#000' : '#fff'};">
                ${statusText}
              </span>
            </div>
            
            ${isBlocked ? `
              <div style="padding:8px; background:rgba(245, 158, 11, 0.1); border:1px solid rgba(245, 158, 11, 0.3); border-radius:6px; margin-bottom:12px; font-size:12px; color:var(--warning);">
                ⚠️ Service disabled - Monitor cannot run
              </div>
            ` : ''}
            
            <div style="font-size:12px; color:var(--muted); margin-bottom:12px;">
              ⏱️ Interval: ${monitor.monitoring_interval}s
              ${monitor.last_searched_at ? `| Last: ${new Date(monitor.last_searched_at).toLocaleString()}` : '| Never searched'}
            </div>
            
            <div style="display:flex; gap:8px;">
              <button 
                onclick="toggleGeographicalMonitor('${monitor.id}', ${monitor.is_running})" 
                class="${buttonClass}" 
                style="flex:1;"
                ${buttonDisabled ? 'disabled title="' + tooltip + '"' : `title="${tooltip}"`}
                ${buttonDisabled ? 'opacity: 0.5; cursor: not-allowed;' : ''}>
                ${buttonText}
              </button>
              <button onclick="deleteGeographicalMonitor('${monitor.id}')" class="danger" title="Delete this monitor">Delete</button>
            </div>
          </div>
        `;
        }).join('');
      }

      // Legacy monitor rendering removed - use geographical monitoring instead

      // Load AI configuration
      async function loadAIConfig() {
        try {
          const data = await apiCall('/api/social-media/ai-config');
          aiConfig = data.config;
          
          if (!aiConfig) {
            // No AI configuration exists yet
            document.getElementById('ai-config-status').innerHTML = 
              '<div style="text-align:center; color:var(--muted); padding:20px;">No AI configuration found. Configure AI to enable threat detection.</div>';
          } else {
            renderAIConfig();
          }
        } catch (error) {
          console.error('Failed to load AI config:', error);
          document.getElementById('ai-config-status').innerHTML = 
            '<div style="text-align:center; color:var(--muted); padding:20px;">No AI configuration found. Configure AI to enable threat detection.</div>';
        }
      }

      // Render AI configuration
      function renderAIConfig() {
        if (!aiConfig) return;
        
        const dedupLabel = aiConfig.deduplication_model ? aiConfig.deduplication_model : aiConfig.model + ' (same)';
        document.getElementById('ai-config-status').innerHTML = `
          <div style="display:flex; justify-content:space-between; align-items:center; padding:16px; background:#0d1b34; border-radius:8px; border:1px solid #223056;">
            <div>
              <div style="font-weight:600; margin-bottom:4px;">AI Configuration Active</div>
              <div style="font-size:12px; color:var(--muted);">
                Search: ${aiConfig.model} · Dedup: ${dedupLabel}
              </div>
            </div>
            <button onclick="showAIConfigModal()" class="secondary">Edit</button>
          </div>
        `;
      }


      // Legacy monitor modal functions removed - use geographical monitoring instead

      function showGeographicalMonitorModal() {
        document.getElementById('geographical-monitor-form').reset();
        document.getElementById('geographical-monitor-modal').classList.remove('hidden');
        updateMonitorIntervalEstimate();
      }

      function updateMonitorIntervalEstimate() {
        const input = document.getElementById('monitor-interval-input');
        const el = document.getElementById('monitor-interval-estimate');
        if (!input || !el) return;
        const sec = parseInt(input.value, 10) || 300;
        const interval = Math.max(60, Math.min(3600, sec));
        const callsPerDay = Math.floor(86400 / interval);
        const avgCostPerSearch = (aiUsageSummary?.last_24h?.search_calls > 0 && aiUsageSummary?.last_24h?.cost_usd != null)
          ? aiUsageSummary.last_24h.cost_usd / aiUsageSummary.last_24h.search_calls
          : 0.01;
        const estCostPerDay = callsPerDay * avgCostPerSearch;
        el.textContent = `~${callsPerDay.toLocaleString()} requests/day • est. ~$${estCostPerDay.toFixed(2)}/day`;
      }

      function showAIConfigModal() {
        document.getElementById('ai-config-form').reset();
        if (aiConfig) {
          document.getElementById('ai-config-form').querySelector('[name="model"]').value = aiConfig.model;
          const dedupSelect = document.getElementById('ai-config-form').querySelector('[name="deduplication_model"]');
          if (dedupSelect) dedupSelect.value = aiConfig.deduplication_model || '';
        }
        document.getElementById('ai-config-modal').classList.remove('hidden');
      }

      function closeModal() {
        document.querySelectorAll('.modal').forEach(modal => modal.classList.add('hidden'));
      }

      // Legacy monitor form handlers removed - use geographical monitoring instead

      async function handleXaiManagementSubmit(e) {
        e.preventDefault();
        const form = e.target;
        const key = (form.management_api_key?.value ?? '').trim();
        const teamId = (form.team_id?.value ?? '').trim();
        if (!key || !teamId) {
          showError('Management API key and Team ID are both required.');
          return;
        }
        try {
          await apiCall('/api/social-media/xai-management-config', {
            method: 'PUT',
            body: JSON.stringify({ management_api_key: key, team_id: teamId })
          });
          showSuccess('xAI Management key saved. Actual balance and usage will appear in the dashboard.');
          closeModal();
          document.getElementById('xai-management-modal').classList.add('hidden');
          await loadAIUsage();
        } catch (err) {
          showError('Failed to save Management key: ' + err.message);
        }
      }

      async function handleAIConfigSubmit(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        
        try {
          if (aiConfig) {
            await apiCall(`/api/social-media/ai-config/${aiConfig.id}`, {
              method: 'PUT',
              body: JSON.stringify(data)
            });
          } else {
            await apiCall('/api/social-media/ai-config', {
              method: 'POST',
              body: JSON.stringify(data)
            });
          }
          
          closeModal();
          loadAIConfig();
          showSuccess('AI configuration saved successfully');
        } catch (error) {
          showError('Failed to save AI configuration: ' + error.message);
        }
      }

      async function handleGeographicalMonitorSubmit(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());

        // Convert checkbox value to boolean
        data.is_active = data.is_active === 'on';
        
        // Convert numeric values
        data.monitoring_interval = parseInt(data.monitoring_interval);
        
        // Convert empty strings to undefined for optional fields
        if (data.search_query === '') {
          data.search_query = undefined;
        }

        try {
          await apiCall('/api/social-media/geographical-monitors', {
            method: 'POST',
            body: JSON.stringify(data)
          });
          
          closeModal();
          loadGeographicalMonitors();
          showSuccess('Geographical monitor created successfully');
        } catch (error) {
          showError('Failed to create geographical monitor: ' + error.message);
        }
      }

      // Geographical monitor actions
      async function toggleGeographicalMonitor(id, isRunning) {
        // Check if service is enabled
        if (!serviceEnabled && !isRunning) {
          showError('Service must be enabled to start monitors. Please enable the service first.');
          return;
        }
        
        try {
          const endpoint = isRunning 
            ? `/api/social-media/geographical-monitors/${id}/stop`
            : `/api/social-media/geographical-monitors/${id}/start`;
          
          await apiCall(endpoint, { method: 'POST' });
          
          // Refresh both service status and monitor list to show updated state
          await Promise.all([
            loadServiceStatus(),
            loadGeographicalMonitors()
          ]);
          showSuccess(`Geographical monitor ${isRunning ? 'stopped' : 'started'} successfully`);
        } catch (error) {
          showError('Failed to toggle geographical monitor: ' + error.message);
        }
      }

      async function deleteGeographicalMonitor(id) {
        if (!confirm('Are you sure you want to delete this geographical monitor?')) return;
        
        try {
          await apiCall(`/api/social-media/geographical-monitors/${id}`, { method: 'DELETE' });
          // Refresh the monitor list to show updated state
          await loadGeographicalMonitors();
          showSuccess('Geographical monitor deleted successfully');
        } catch (error) {
          showError('Failed to delete geographical monitor: ' + error.message);
        }
      }

      // Legacy monitor actions removed - use geographical monitoring instead

      // Legacy test functions removed - use geographical monitoring instead

      async function testAI() {
        const form = document.getElementById('ai-config-form');
        const apiKey = form.querySelector('[name="api_key_encrypted"]').value;
        const model = form.querySelector('[name="model"]').value;
        
        if (!apiKey) {
          showError('Please enter Grok API key');
          return;
        }
        
        // Get the test button and add loading state
        const testButton = document.querySelector('button[onclick="testAI()"]');
        const originalText = testButton.textContent;
        const originalDisabled = testButton.disabled;
        
        // Show loading state
        testButton.textContent = 'Testing...';
        testButton.disabled = true;
        testButton.classList.add('loading');
        
        try {
          const result = await apiCall('/api/social-media/test-ai', {
            method: 'POST',
            body: JSON.stringify({ api_key: apiKey, model: model })
          });
          
          if (result.success) {
            showSuccess(`Grok AI connection successful! Using model: ${result.model}`);
          } else {
            let errorMsg = 'Grok AI connection failed: ' + result.error;
            if (result.error.includes('404') || result.error.includes('not found')) {
              errorMsg += '\n\nNote: The Grok API may not be publicly available yet. Please check x.ai for the latest API availability.';
            }
            showError(errorMsg);
          }
        } catch (error) {
          showError('AI test failed: ' + error.message);
        } finally {
          // Restore button state
          testButton.textContent = originalText;
          testButton.disabled = originalDisabled;
          testButton.classList.remove('loading');
        }
      }


      // Utility functions
      function showSuccess(message) {
        showMessage(message, 'success');
      }

      function showError(message) {
        showMessage(message, 'error');
      }

      function showMessage(message, type) {
        const messageEl = document.getElementById('globalMessage');
        messageEl.textContent = message;
        messageEl.className = `message message-${type}`;
        messageEl.classList.remove('hidden');
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
          messageEl.classList.add('fade-out');
          setTimeout(() => {
            messageEl.classList.add('hidden');
            messageEl.classList.remove('fade-out');
          }, 300);
        }, 5000);
      }

      // Service control functions
      async function toggleService() {
        try {
          const enabled = !serviceStatus.service_enabled;
          await apiCall('/api/social-media/service/toggle', {
            method: 'POST',
            body: JSON.stringify({ enabled })
          });
          
          loadServiceStatus();
          showSuccess(`Service ${enabled ? 'enabled' : 'disabled'} successfully`);
        } catch (error) {
          showError('Failed to toggle service: ' + error.message);
        }
      }

      async function startAllMonitors() {
        try {
          const result = await apiCall('/api/social-media/service/start-all', {
            method: 'POST'
          });
          
          loadServiceStatus();
          loadGeographicalMonitors();
          showSuccess(`Started ${result.result.started} geographical monitors`);
          
          if (result.result.failed > 0) {
            showError(`Failed to start ${result.result.failed} monitors: ${result.result.errors.join(', ')}`);
          }
        } catch (error) {
          showError('Failed to start monitors: ' + error.message);
        }
      }

      async function stopAllMonitors() {
        try {
          const result = await apiCall('/api/social-media/service/stop-all', {
            method: 'POST'
          });
          
          loadServiceStatus();
          loadGeographicalMonitors();
          showSuccess(`Stopped ${result.result.stopped} geographical monitors`);
        } catch (error) {
          showError('Failed to stop monitors: ' + error.message);
        }
      }

      function showServiceConfigModal() {
        if (!serviceConfig) return;
        
        const form = document.getElementById('service-config-form');
        form.querySelector('[name="auto_start_monitors"]').checked = serviceConfig.auto_start_monitors;
        form.querySelector('[name="max_monitors_per_team"]').value = serviceConfig.max_monitors_per_team;
        form.querySelector('[name="default_monitoring_interval"]').value = serviceConfig.default_monitoring_interval;
        form.querySelector('[name="max_posts_per_hour"]').value = serviceConfig.service_settings?.max_posts_per_hour || 100;
        
        document.getElementById('service-config-modal').classList.remove('hidden');
      }

      // Show detailed service status modal
      async function showServiceStatusModal() {
        try {
          const detailedStatus = await loadDetailedServiceStatus();
          if (!detailedStatus) {
            showError('Failed to load detailed service status');
            return;
          }
          
          renderDetailedServiceStatus(detailedStatus);
          document.getElementById('service-status-modal').classList.remove('hidden');
        } catch (error) {
          showError('Failed to load detailed service status: ' + error.message);
        }
      }

      // Render detailed service status
      function renderDetailedServiceStatus(status) {
        const container = document.getElementById('detailed-service-status');
        
        container.innerHTML = `
          <div class="grid" style="margin-bottom: 20px;">
            <div class="card" style="padding: 16px;">
              <h3 style="margin: 0 0 12px;">System Health</h3>
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <div class="status-indicator ${status.system.healthy ? 'active' : 'inactive'}"></div>
                <span>Overall Health: ${status.system.healthy ? 'Healthy' : 'Unhealthy'}</span>
              </div>
              <div style="font-size: 12px; color: var(--muted);">
                Uptime: ${status.system.uptime || 'Unknown'}
              </div>
            </div>
            
            <div class="card" style="padding: 16px;">
              <h3 style="margin: 0 0 12px;">Database</h3>
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                <div class="status-indicator ${status.database.connected ? 'active' : 'inactive'}"></div>
                <span>Connection: ${status.database.connected ? 'Connected' : 'Disconnected'}</span>
              </div>
              <div style="font-size: 12px; color: var(--muted);">
                Pool: ${status.database.pool?.active || 0}/${status.database.pool?.total || 0}
              </div>
            </div>
          </div>
          
          <div class="card" style="padding: 16px; margin-bottom: 20px;">
            <h3 style="margin: 0 0 12px;">Social Media Service</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <div class="status-indicator ${status.socialMedia?.enabled ? 'active' : 'inactive'}"></div>
                <span>Service: ${status.socialMedia?.enabled ? 'Enabled' : 'Disabled'}</span>
              </div>
              <div style="display: flex; align-items: center; gap: 8px;">
                <div class="status-indicator ${status.socialMedia?.healthMonitoring ? 'active' : 'inactive'}"></div>
                <span>Health Monitoring: ${status.socialMedia?.healthMonitoring ? 'Active' : 'Inactive'}</span>
              </div>
              <div style="display: flex; align-items: center; gap: 8px;">
                <div class="status-indicator ${status.socialMedia?.recoveryMonitoring ? 'active' : 'inactive'}"></div>
                <span>Recovery: ${status.socialMedia?.recoveryMonitoring ? 'Active' : 'Inactive'}</span>
              </div>
              <div style="display: flex; align-items: center; gap: 8px;">
                <div class="status-indicator ${status.socialMedia?.aiService ? 'active' : 'inactive'}"></div>
                <span>AI Service: ${status.socialMedia?.aiService ? 'Available' : 'Unavailable'}</span>
              </div>
            </div>
            <div style="margin-top: 12px; font-size: 12px; color: var(--muted);">
              Active Monitors: ${status.socialMedia?.activeMonitors || 0} | 
              Total Monitors: ${status.socialMedia?.totalMonitors || 0} | 
              Posts Today: ${status.socialMedia?.postsToday || 0}
            </div>
          </div>
          
          <div class="card" style="padding: 16px;">
            <h3 style="margin: 0 0 12px;">Retention Service</h3>
            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
              <div class="status-indicator ${status.retention?.running ? 'active' : 'inactive'}"></div>
              <span>Service: ${status.retention?.running ? 'Running' : 'Stopped'}</span>
            </div>
            <div style="font-size: 12px; color: var(--muted);">
              Last Run: ${status.retention?.lastRun || 'Never'} | 
              Next Run: ${status.retention?.nextRun || 'Unknown'}
            </div>
          </div>
        `;
      }

      // Refresh service status
      async function refreshServiceStatus() {
        try {
          await loadServiceStatus();
          showSuccess('Service status refreshed');
        } catch (error) {
          showError('Failed to refresh service status: ' + error.message);
        }
      }

      async function handleServiceConfigSubmit(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData.entries());
        
        // Convert checkbox values to booleans
        data.auto_start_monitors = data.auto_start_monitors === 'on';
        
        // Convert numeric values
        data.max_monitors_per_team = parseInt(data.max_monitors_per_team);
        data.default_monitoring_interval = parseInt(data.default_monitoring_interval);
        data.max_posts_per_hour = parseInt(data.max_posts_per_hour);
        
        try {
          await apiCall('/api/social-media/service/config', {
            method: 'PUT',
            body: JSON.stringify(data)
          });
          
          closeModal();
          loadServiceConfig();
          showSuccess('Service configuration updated successfully');
        } catch (error) {
          showError('Failed to update service configuration: ' + error.message);
        }
      }

      // Auto-refresh functionality
      function startStatusAutoRefresh() {
        // Refresh service status and AI usage every 30 seconds
        statusRefreshInterval = setInterval(async () => {
          try {
            await loadServiceStatus();
            await loadAIUsage();
          } catch (error) {
            console.warn('Auto-refresh failed:', error);
          }
        }, 30000);
      }

      function stopStatusAutoRefresh() {
        if (statusRefreshInterval) {
          clearInterval(statusRefreshInterval);
          statusRefreshInterval = null;
        }
      }

      // Clean up on page unload
      window.addEventListener('beforeunload', () => {
        stopStatusAutoRefresh();
      });

      // Close modals when clicking outside
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal')) {
          closeModal();
        }
      });
    </script>
  </body>
</html>
