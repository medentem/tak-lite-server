<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TAK Lite Admin</title>
    <style>
      :root { --bg:#0b1220; --panel:#111a2b; --text:#e6edf3; --muted:#8b97a7; --accent:#3b82f6; --ok:#22c55e; --bad:#ef4444; }
      html,body { height:100%; }
      body { margin:0; background:linear-gradient(180deg,#0b1220,#0a0f1a); color:var(--text); font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; }
      .container { max-width:1100px; margin:0 auto; padding:24px; }
      header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
      .brand { font-weight:700; letter-spacing:.3px; }
      .card { background:var(--panel); border:1px solid #1f2a44; border-radius:12px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
      .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:16px; }
      input,button { height:40px; border-radius:8px; border:1px solid #233153; background:#0c1527; color:var(--text); padding:0 12px; }
      input::placeholder { color:#6b7280; }
      button { background:linear-gradient(180deg,#2563eb,#1d4ed8); border:0; cursor:pointer; font-weight:600; }
      button.secondary { background:#0c1527; border:1px solid #223056; }
      .row { display:flex; gap:8px; align-items:center; }
      .section { margin-top:16px; }
      h2 { margin:0 0 8px; font-size:18px; color:#cbd5e1; }
      .kpi { display:flex; align-items:center; gap:8px; }
      .kpi .value { font-size:22px; font-weight:700; }
      table { width:100%; border-collapse:collapse; font-size:14px; }
      th, td { border-bottom:1px solid #1f2a44; padding:10px; text-align:left; }
      .muted { color:var(--muted); }
      .pill { padding:2px 8px; border-radius:9999px; background:#0d1b34; border:1px solid #223056; font-size:12px; }
      .spacer { height:16px; }
      .right { text-align:right; }
      .hidden { display:none; }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <div class="brand">TAK Lite Admin</div>
        <div class="row">
          <span id="who" class="muted hidden"></span>
          <button id="logout" class="secondary hidden">Logout</button>
        </div>
      </header>

      <div id="loginCard" class="card">
        <h2>Sign in</h2>
        <div class="row">
          <input id="email" type="email" placeholder="admin@example.com" style="flex:1" />
          <input id="password" type="password" placeholder="password" style="flex:1" />
          <button id="login">Login</button>
        </div>
        <div id="loginMsg" class="section muted"></div>
      </div>

      <div id="dash" class="hidden">
        <div class="grid">
          <div class="card">
            <h2>Overview</h2>
            <div class="grid">
              <div class="kpi"><span class="pill">Users</span><span id="k_users" class="value">-</span></div>
              <div class="kpi"><span class="pill">Teams</span><span id="k_teams" class="value">-</span></div>
              <div class="kpi"><span class="pill">Sockets</span><span id="k_sockets" class="value">-</span></div>
              <div class="kpi"><span class="pill">Auth</span><span id="k_auth" class="value">-</span></div>
            </div>
            <div class="spacer"></div>
            <table>
              <tbody>
                <tr><td class="muted">Uptime</td><td id="k_uptime" class="right">-</td></tr>
                <tr><td class="muted">Node</td><td id="k_node" class="right">-</td></tr>
                <tr><td class="muted">Load</td><td id="k_load" class="right">-</td></tr>
                <tr><td class="muted">Memory</td><td id="k_mem" class="right">-</td></tr>
              </tbody>
            </table>
          </div>

          <div class="card">
            <h2>Configuration</h2>
            <div class="section row"><span class="muted" style="width:100px">Org</span><input id="org" style="flex:1" /></div>
            <div class="section row"><span class="muted" style="width:100px">CORS</span><input id="cors" style="flex:1" /></div>
            <div class="section row right"><button id="save" class="secondary">Save</button></div>
            <div id="saveMsg" class="muted"></div>
          </div>
        </div>

        <div class="section card">
          <h2>Sockets</h2>
          <pre id="rooms" class="muted" style="white-space:pre-wrap; margin:0"></pre>
        </div>

        <div class="section grid">
          <div class="card">
            <h2>Users</h2>
            <div class="row">
              <input id="u_email" type="email" placeholder="user@example.com" style="flex:1" />
              <input id="u_name" type="text" placeholder="Name" style="flex:1" />
              <label class="row" style="gap:6px"><input id="u_admin" type="checkbox" /> Admin</label>
              <button id="u_create">Create</button>
            </div>
            <div id="u_msg" class="muted"></div>
            <table id="u_table"><thead><tr><th>Email</th><th>Name</th><th>Admin</th><th>Actions</th></tr></thead><tbody></tbody></table>
          </div>

          <div class="card">
            <h2>Teams</h2>
            <div class="row">
              <input id="t_name" type="text" placeholder="Team name" style="flex:1" />
              <button id="t_create">Create</button>
            </div>
            <div class="row section">
              <select id="t_select" style="flex:1"></select>
              <select id="t_user_select" style="flex:1"></select>
              <button id="t_add_member">Add member</button>
            </div>
            <div id="t_msg" class="muted"></div>
            <table id="t_table"><thead><tr><th>User</th><th>Email</th><th>Actions</th></tr></thead><tbody></tbody></table>
          </div>
        </div>
      </div>
    </div>

    <script>
      let token = localStorage.getItem('taklite:token') || '';
      const q = (s)=>document.querySelector(s);
      function hdrs(add={}) { const h = { 'Content-Type':'application/json' }; if (token) h['Authorization'] = 'Bearer '+token; return Object.assign(h, add); }
      async function jget(url, opts={}) {
        const res = await fetch(url, Object.assign({ headers: hdrs() }, opts));
        if (!res.ok) throw await res.json().catch(()=>({error:res.status}));
        return res.json();
      }
      function showDash(show) {
        q('#loginCard').classList.toggle('hidden', show);
        q('#dash').classList.toggle('hidden', !show);
        q('#logout').classList.toggle('hidden', !show);
        q('#who').classList.toggle('hidden', !show);
      }
      async function refresh() {
        if (!token) return;
        try {
          const [cfg, stats, teams, users] = await Promise.all([
            jget('/api/admin/config'),
            jget('/api/admin/stats'),
            jget('/api/admin/teams'),
            jget('/api/admin/users')
          ]);
          q('#org').value = cfg.orgName || '';
          q('#cors').value = cfg.corsOrigin || '';
          q('#k_users').textContent = stats.db.users ?? '-';
          q('#k_teams').textContent = stats.db.teams ?? '-';
          q('#k_sockets').textContent = stats.sockets.totalConnections ?? 0;
          q('#k_auth').textContent = stats.sockets.authenticatedConnections ?? 0;
          q('#k_uptime').textContent = stats.server.uptimeSec + 's';
          q('#k_node').textContent = stats.server.node;
          q('#k_load').textContent = (stats.server.loadavg||[]).map(n=>n.toFixed(2)).join(' / ');
          q('#k_mem').textContent = (stats.server.memory.heapUsed/1048576).toFixed(1)+' MB';
          q('#rooms').textContent = JSON.stringify(stats.sockets.rooms, null, 2);

          // Populate users table
          const utb = q('#u_table tbody'); utb.innerHTML='';
          users.forEach(u=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${u.email}</td><td>${u.name||''}</td><td>${u.is_admin?'Yes':'No'}</td><td>
              <button data-act="reset" data-id="${u.id}" class="secondary">Reset PW</button>
              <button data-act="del" data-id="${u.id}" class="secondary">Delete</button>
            </td>`;
            utb.appendChild(tr);
          });

          // Populate teams select and table
          const tsel = q('#t_select'); tsel.innerHTML='';
          teams.forEach(t=>{ const o=document.createElement('option'); o.value=t.id; o.textContent=t.name; tsel.appendChild(o); });
          const usel = q('#t_user_select'); usel.innerHTML='';
          users.forEach(u=>{ const o=document.createElement('option'); o.value=u.id; o.textContent=`${u.name||''} <${u.email}>`; usel.appendChild(o); });
          if (teams[0]) await loadTeamMembers(teams[0].id);
        } catch (e) { console.error(e); }
      }

      async function loadTeamMembers(teamId){
        const members = await jget(`/api/admin/teams/${teamId}/members`);
        const tb = q('#t_table tbody'); tb.innerHTML='';
        members.forEach(m=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${m.name||''}</td><td>${m.email}</td><td>
            <button data-act="kick" data-uid="${m.id}" class="secondary">Remove</button>
          </td>`;
          tb.appendChild(tr);
        });
      }

      q('#login').onclick = async () => {
        try {
          const res = await fetch('/api/auth/login', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ email:q('#email').value, password:q('#password').value }) });
        if (!res.ok) throw await res.json().catch(()=>({error:res.status}));
          const data = await res.json();
          token = data.token; localStorage.setItem('taklite:token', token);
          q('#who').textContent = q('#email').value;
          showDash(true);
          refresh();
        } catch (e) { q('#loginMsg').textContent = 'Login failed'; }
      };
      q('#logout').onclick = () => { token=''; localStorage.removeItem('taklite:token'); showDash(false); };
      q('#save').onclick = async () => {
        try { await fetch('/api/admin/config', { method:'PUT', headers: hdrs(), body: JSON.stringify({ orgName:q('#org').value, corsOrigin:q('#cors').value }) }); q('#saveMsg').textContent='Saved'; }
        catch { q('#saveMsg').textContent='Save failed'; }
      };

      // Users create
      q('#u_create').onclick = async () => {
        try {
          const body = { email:q('#u_email').value, name:q('#u_name').value, is_admin:q('#u_admin').checked };
          const res = await fetch('/api/admin/users', { method:'POST', headers: hdrs(), body: JSON.stringify(body) });
          const data = await res.json(); if(!res.ok) throw data;
          q('#u_msg').textContent = `Created. Temporary password: ${data.password}`;
          await refresh();
        } catch(e){ q('#u_msg').textContent = 'Create failed'; }
      };

      // Delegate table actions for users
      q('#u_table').onclick = async (ev)=>{
        const btn = ev.target.closest('button'); if(!btn) return;
        const id = btn.getAttribute('data-id'); const act = btn.getAttribute('data-act');
        if (act==='reset') {
          const res = await fetch(`/api/admin/users/${id}/reset-password`, { method:'POST', headers: hdrs() });
          const data = await res.json(); if(!res.ok) return alert('Reset failed');
          alert('New password: '+data.password);
        } else if (act==='del') {
          await fetch(`/api/admin/users/${id}`, { method:'DELETE', headers: hdrs() });
          await refresh();
        }
      };

      // Teams create and membership
      q('#t_create').onclick = async ()=>{
        try { const res = await fetch('/api/admin/teams', { method:'POST', headers: hdrs(), body: JSON.stringify({ name:q('#t_name').value }) }); if(!res.ok) throw 0; await refresh(); }
        catch { q('#t_msg').textContent='Create failed'; }
      };
      q('#t_add_member').onclick = async ()=>{
        const teamId = q('#t_select').value; const userId = q('#t_user_select').value;
        try { const res = await fetch(`/api/admin/teams/${teamId}/members`, { method:'POST', headers: hdrs(), body: JSON.stringify({ userId }) }); if(!res.ok) throw 0; await loadTeamMembers(teamId); }
        catch { q('#t_msg').textContent='Add failed'; }
      };
      q('#t_select').onchange = ()=> loadTeamMembers(q('#t_select').value);

      if (token) { showDash(true); refresh(); }
    </script>
  </body>
</html>


