<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TAK Lite Admin</title>
    <link rel="stylesheet" href="/public/css/variables.css" />
    <link rel="stylesheet" href="/public/css/base.css" />
    <link rel="stylesheet" href="/public/css/components.css" />
    <link rel="stylesheet" href="/public/css/pages/admin.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <div class="brand">
          TAK Lite Admin
          <span class="version-separator">|</span>
          <span id="header_version" class="version-text">-</span>
        </div>
        <div class="row">
          <span id="who" class="muted hidden"></span>
          <button id="logout" class="secondary hidden">Logout</button>
        </div>
      </header>

      <!-- Navigation -->
      <nav id="adminNav" class="hidden" style="margin-bottom: 20px;">
        <div class="card" style="padding: 12px 16px;">
          <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
            <a href="#" id="nav-dashboard" style="color: var(--text); text-decoration: none; padding: 8px 12px; border-radius: 6px; background: var(--accent); font-weight: 500; cursor: pointer;">Dashboard</a>
            <a href="#" id="nav-threats" style="color: var(--muted); text-decoration: none; padding: 8px 12px; border-radius: 6px; transition: all 0.2s; cursor: pointer;">Threat Review</a>
            <a href="#" id="nav-messages" style="color: var(--muted); text-decoration: none; padding: 8px 12px; border-radius: 6px; transition: all 0.2s; cursor: pointer;">Messages</a>
            <a href="#" id="nav-settings" style="color: var(--muted); text-decoration: none; padding: 8px 12px; border-radius: 6px; transition: all 0.2s; cursor: pointer;">Settings</a>
            <a href="#" id="nav-management" style="color: var(--muted); text-decoration: none; padding: 8px 12px; border-radius: 6px; transition: all 0.2s; cursor: pointer;">Management</a>
            <a href="/social-media" id="nav-social" style="color: var(--muted); text-decoration: none; padding: 8px 12px; border-radius: 6px; transition: all 0.2s;">Social Media</a>
          </div>
        </div>
      </nav>

      <div id="loginCard" class="card hidden">
        <h2>Sign in</h2>
        <div class="row">
          <input id="email" type="email" placeholder="admin@example.com" style="flex:1" />
          <input id="password" type="password" placeholder="password" style="flex:1" />
          <button id="login">Login</button>
        </div>
        <div id="loginMsg" class="message message-error hidden"></div>
      </div>

      <!-- Settings Page -->
      <div id="settingsPage" class="hidden">
        <div class="card">
          <h2>Settings</h2>
          <div class="help-text">
            <strong>Server configuration</strong> for organization settings, security, and data retention
          </div>
          
          <div class="field-group">
            <label for="org">Organization Name</label>
            <input id="org" />
            <div class="help-text">
              <strong>Display name</strong> for your organization that appears in the TAK Lite app
            </div>
          </div>
          
          <div class="field-group">
            <label for="cors">Allowed Websites (CORS)</label>
            <input id="cors" placeholder="http://localhost:3000" />
            <div class="help-text">
              <strong>What is this?</strong> Controls which websites can connect to your server.<br>
              <strong>Leave blank</strong> if you're only using the TAK Lite mobile app.<br>
              <strong>Example:</strong> http://localhost:3000, https://myapp.com
            </div>
          </div>
          
          <div class="field-group">
            <label for="retention">Data Retention Period (days)</label>
            <input id="retention" type="number" min="0" max="365" />
            <div class="help-text">
              <strong>How long to keep:</strong> Location history, messages, and annotations<br>
              <strong>0 days:</strong> Keep everything forever (uses more storage)<br>
              <strong>30 days:</strong> Good balance for most teams<br>
              <strong>90+ days:</strong> For compliance or long-term projects
            </div>
          </div>
          
          <button id="save" class="secondary save-button">Save Changes</button>
          <div id="saveMsg" class="message hidden"></div>
        </div>
      </div>

      <!-- Management Page -->
      <div id="managementPage" class="hidden">
        <div class="grid">
          <div class="card">
            <h2>Users</h2>
            <p class="help-text" style="margin-top:0;margin-bottom:12px;">New users are created as regular users. To grant admin access, create the user first, then use <strong>Edit</strong> on that user.</p>
            <div class="row">
              <input id="u_email" type="email" placeholder="user@example.com" />
              <input id="u_name" type="text" placeholder="Name" />
              <button id="u_create">Create User</button>
            </div>
            <div id="u_msg" class="message hidden"></div>
            <div id="u_password_reveal" class="hidden" style="margin-top:12px;padding:12px;background:var(--panel);border:1px solid #1f2a44;border-radius:8px;color:var(--text);">
              <p id="u_password_label" style="margin:0 0 8px 0;font-size:0.9em;color:var(--muted);"></p>
              <div class="row" style="align-items:center;gap:8px;flex-wrap:wrap;">
                <code id="u_password_display" style="flex:1;min-width:120px;padding:6px 10px;background:#0d1b34;border:1px solid #1f2a44;border-radius:4px;font-size:0.95em;color:var(--text);"></code>
                <button type="button" id="u_password_copy" class="secondary">Copy</button>
              </div>
            </div>
            <div class="users-table">
              <table id="u_table"><thead><tr><th>Email</th><th>Name</th><th>Admin</th><th>Actions</th></tr></thead><tbody></tbody></table>
            </div>
          </div>

          <div class="card">
            <h2>Teams</h2>
            <div class="row">
              <input id="t_name" type="text" placeholder="Team name" />
              <button id="t_create">Create Team</button>
            </div>
            <div class="row section">
              <select id="t_select" style="flex:1"></select>
              <select id="t_user_select" style="flex:1"></select>
              <button id="t_add_member">Add Member</button>
            </div>
            <div id="t_msg" class="message hidden"></div>
            <div class="teams-table">
              <table id="t_table"><thead><tr><th>User</th><th>Email</th><th>Actions</th></tr></thead><tbody></tbody></table>
            </div>
          </div>
        </div>
      </div>

      <!-- Threat Review Page -->
      <div id="threatsPage" class="hidden">
        <div class="card">
          <h2>AI Threat Review</h2>
          <div class="help-text">
            <strong>Review and manage AI-detected threats</strong> from geographical monitoring and social media analysis
          </div>
          
          <div style="display: flex; gap: 12px; margin-bottom: 16px; align-items: center;">
            <select id="threat_status_filter" style="flex: 1; min-width: 150px;">
              <option value="pending">Pending Review</option>
              <option value="reviewed">Reviewed</option>
              <option value="approved">Approved</option>
              <option value="dismissed">Dismissed</option>
              <option value="all">All Threats</option>
            </select>
            <select id="threat_level_filter" style="flex: 1; min-width: 150px;">
              <option value="">All Levels</option>
              <option value="LOW">Low</option>
              <option value="MEDIUM">Medium</option>
              <option value="HIGH">High</option>
              <option value="CRITICAL">Critical</option>
            </select>
            <button id="refresh_threats" class="secondary">Refresh</button>
            <div style="display: flex; gap: 8px; align-items: center;">
              <label style="display: flex; align-items: center; gap: 4px; font-size: 14px;">
                <input id="threat_auto_refresh" type="checkbox" checked />
                Auto-refresh
              </label>
            </div>
          </div>
          
          <div id="threats_list" style="max-height: 600px; overflow-y: auto; border: 1px solid #1f2a44; border-radius: 8px; background: #0c1527;">
            <div class="muted" style="text-align: center; padding: 20px;">Loading threats...</div>
          </div>
          
          <div style="margin-top: 16px; font-size: 13px;">
            <strong>Threat Review Controls:</strong>
            <div style="margin-top: 8px; color: var(--muted);">
              ‚Ä¢ Review AI-detected threats and their confidence scores<br>
              ‚Ä¢ Approve threats to create map annotations for teams<br>
              ‚Ä¢ Dismiss false positives or irrelevant threats<br>
              ‚Ä¢ Real-time notifications for new threats appear here
            </div>
          </div>
        </div>
      </div>

      <!-- Messages Page -->
      <div id="messagesPage" class="hidden">
        <div class="card">
          <h2>Live Message Monitoring</h2>
          <div class="help-text">
            <strong>Real-time message monitoring</strong> showing all team communications as they happen
          </div>
          
          <div style="display: flex; gap: 12px; margin-bottom: 16px; align-items: center;">
            <select id="message_team_filter" style="flex: 1; min-width: 200px;">
              <option value="">All Teams</option>
            </select>
            <button id="clear_messages" class="secondary">Clear Messages</button>
            <div style="display: flex; gap: 8px; align-items: center;">
              <label style="display: flex; align-items: center; gap: 4px; font-size: 14px;">
                <input id="message_auto_scroll" type="checkbox" checked />
                Auto-scroll
              </label>
              <label style="display: flex; align-items: center; gap: 4px; font-size: 14px;">
                <input id="message_show_timestamps" type="checkbox" checked />
                Show timestamps
              </label>
            </div>
          </div>
          
          <div id="message_monitor" style="height: 600px; border-radius: 8px; overflow: hidden; background: #0c1527; border: 1px solid #1f2a44; padding: 12px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 13px;">
            <div class="muted" style="text-align: center; padding: 20px;">Waiting for messages...</div>
          </div>
          
          <div style="margin-top: 16px; font-size: 13px;">
            <strong>Message Controls:</strong>
            <div style="margin-top: 8px; color: var(--muted);">
              ‚Ä¢ Messages appear in real-time as they are sent<br>
              ‚Ä¢ Use team filter to focus on specific teams<br>
              ‚Ä¢ Auto-scroll keeps the latest messages visible<br>
              ‚Ä¢ Messages are stored for the current session only
            </div>
          </div>
        </div>
      </div>

      <!-- Dashboard Page -->
      <div id="dash" class="hidden dashboard-fullscreen">
        <!-- Global message area -->
        <div id="globalMessage" class="message hidden"></div>
        
        <!-- Minimal Top Status Bar (Always Visible) -->
        <div class="dashboard-status-bar">
          <div class="status-bar-left">
            <div class="status-item">
              <span class="status-label">Users:</span>
              <span class="status-value" id="k_users">-</span>
            </div>
            <div class="status-item">
              <span class="status-label">Teams:</span>
              <span class="status-value" id="k_teams">-</span>
            </div>
            <div class="status-item">
              <span class="status-label">Sync:</span>
              <span class="status-value" id="k_sync_status" style="color: #8b97a7;">-</span>
            </div>
            <div class="status-item">
              <span class="status-label">Connection:</span>
              <span class="status-value" id="ws_status" style="color: #ef4444;">Disconnected</span>
            </div>
          </div>
          <div class="status-bar-right">
            <div class="status-item clickable" id="threats-badge">
              <span class="status-label">Threats:</span>
              <span class="status-value threat-badge" id="k_active_threats">0</span>
            </div>
            <div class="status-item clickable" id="messages-badge">
              <span class="status-label">Messages:</span>
              <span class="status-value message-badge" id="k_recent_messages">0</span>
            </div>
            <button id="command-palette-toggle" class="command-palette-btn" title="Command Palette (‚åòK)">‚åòK</button>
          </div>
        </div>

        <!-- Full-Screen Map Container -->
        <div class="dashboard-map-fullscreen">
          <!-- Map Controls Overlay (Top Right) -->
          <div class="map-controls-overlay">
            <select id="map_team_select" class="map-control-select">
              <option value="">All Teams</option>
            </select>
            <div class="map-style-toggle" title="Map style">
              <button type="button" id="map_style_street" class="map-style-btn active" aria-pressed="true">Street</button>
              <button type="button" id="map_style_satellite" class="map-style-btn" aria-pressed="false">Satellite</button>
            </div>
            <button id="map_refresh" class="map-control-btn" title="Refresh Data">‚Üª</button>
            <button id="map_center" class="map-control-btn" title="Center Map">‚åÇ</button>
            <button id="map_clear_all" class="map-control-btn danger" title="Clear All">‚úï</button>
            <div class="map-control-toggle">
              <label class="map-control-label">
                <input id="map_show_annotations" type="checkbox" checked />
                <span>Annotations</span>
              </label>
              <label class="map-control-label">
                <input id="map_show_locations" type="checkbox" checked />
                <span>Locations</span>
              </label>
              <label class="map-control-label" id="map_show_monitors_wrapper" style="display: none;">
                <input id="map_show_monitors" type="checkbox" />
                <span>Monitor areas</span>
              </label>
            </div>
          </div>

          <!-- Full-Screen Map -->
          <div id="map_container" class="map-container-fullscreen">
            <!-- Fan Menu for Annotation Creation -->
            <div id="fan_menu" class="fan-menu">
              <!-- Center hole with dot and coordinate text -->
              <div class="fan-menu-center">
                <div class="fan-menu-center-dot"></div>
                <div class="fan-menu-center-text fan-menu-center-coords" id="fan_menu_coords">0.00000, 0.00000</div>
                <div class="fan-menu-center-text fan-menu-center-distance" id="fan_menu_distance">0.0 mi away</div>
              </div>
              <!-- Donut ring segments will be dynamically added here -->
            </div>
            
            <!-- Color Menu for Annotation Creation -->
            <div id="color_menu" class="color-menu">
              <!-- Color options will be dynamically added here -->
            </div>
            
            <!-- Shape Menu for POI shape editing -->
            <div id="shape_menu" class="shape-menu">
              <!-- Shape options will be dynamically added here -->
            </div>
            
            <!-- Map Interaction Feedback -->
            <div id="map_feedback" class="map-interaction-feedback">
              <!-- Feedback messages will be shown here -->
            </div>
          </div>

          <!-- Left HUD stack: threats on top, messages directly below; both expand and push each other -->
          <div class="hud-panels-stack">
            <!-- Floating HUD Panel: Threats -->
            <div id="threats-hud-panel" class="hud-panel hud-panel-left">
              <div class="hud-panel-header">
                <div class="hud-panel-title">
                  <span class="hud-panel-icon">‚ö†Ô∏è</span>
                  <span>Threat Intelligence</span>
                  <span class="hud-panel-badge" id="threats-hud-badge">0</span>
                </div>
                <div class="hud-panel-actions">
                  <button class="hud-panel-pin" id="threats-pin" title="Pin Panel">üìå</button>
                  <a href="#" id="view-all-threats" class="hud-panel-link">View All ‚Üí</a>
                </div>
              </div>
              <div class="hud-panel-content" id="threats-hud-content">
                <div class="muted" style="text-align: center; padding: 20px; font-size: 13px;">Loading threats...</div>
              </div>
            </div>

            <!-- Floating HUD Panel: Communication Hub (directly below threats) -->
            <div id="messages-hud-panel" class="hud-panel hud-panel-left">
            <div class="hud-panel-header">
              <div class="hud-panel-title">
                <span class="hud-panel-icon">üí¨</span>
                <span>Communication Hub</span>
                <span class="hud-panel-badge" id="messages-hud-badge">0</span>
              </div>
              <div class="hud-panel-actions">
                <button class="hud-panel-pin" id="messages-pin" title="Pin Panel">üìå</button>
                <a href="#" id="view-all-messages" class="hud-panel-link">View All ‚Üí</a>
              </div>
            </div>
            <div class="hud-panel-filters">
              <select id="message_team_filter_compact" class="hud-panel-select">
                <option value="">All Teams</option>
              </select>
              <button id="clear_messages_compact" class="hud-panel-btn">Clear</button>
            </div>
            <div class="hud-panel-content" id="messages-hud-content">
              <div class="muted" style="text-align: center; padding: 20px;">Waiting for messages...</div>
            </div>
          </div>
          </div>
        </div>

        <!-- Command Palette -->
        <div id="command-palette" class="command-palette hidden">
          <div class="command-palette-input-wrapper">
            <input type="text" id="command-palette-input" class="command-palette-input" placeholder="Type a command or search...">
          </div>
          <div id="command-palette-results" class="command-palette-results"></div>
        </div>
      </div>
    </div>

    <!-- Modal Overlay for Forms -->
    <div id="modal_overlay" class="modal-overlay"></div>
    
    <!-- Annotation Edit Form -->
    <div id="annotation_edit_form" class="annotation-edit-form" style="display: none;">
      <h3 id="edit_form_title">Edit Annotation</h3>
      <form id="edit_annotation_form">
        <div class="form-group">
          <label for="edit_label">Label</label>
          <input type="text" id="edit_label" name="label" placeholder="Enter annotation label">
        </div>
        
        <div class="form-group">
          <label for="edit_color">Color</label>
          <select id="edit_color" name="color">
            <option value="green">Green</option>
            <option value="yellow">Yellow</option>
            <option value="red">Red</option>
            <option value="black">Black</option>
            <option value="white">White</option>
          </select>
        </div>
        
        <div class="form-group" id="edit_shape_group" style="display: none;">
          <label for="edit_shape">Shape</label>
          <select id="edit_shape" name="shape">
            <option value="circle">Circle</option>
            <option value="square">Square</option>
            <option value="triangle">Triangle</option>
            <option value="exclamation">Exclamation</option>
          </select>
        </div>
        
        <div class="form-group" id="edit_radius_group" style="display: none;">
          <label for="edit_radius">Radius (meters)</label>
          <input type="number" id="edit_radius" name="radius" min="1" max="10000" step="1">
        </div>
        
        <div class="form-actions">
          <button type="button" id="edit_cancel" class="btn-secondary">Cancel</button>
          <button type="button" id="edit_delete" class="btn-secondary" style="background: #E91E63; color: white;">Delete</button>
          <button type="submit" id="edit_save" class="btn-primary">Save Changes</button>
        </div>
      </form>
    </div>

    <script>
      // Load Socket.IO with CDN fallback
      function loadSocketIO() {
        const script = document.createElement('script');
        script.src = 'https://cdn.socket.io/4.7.2/socket.io.min.js';
        script.onload = function() {
          console.log('Socket.IO library loaded from primary CDN');
        };
        script.onerror = function() {
          console.warn('Primary CDN failed, trying fallback...');
          // Try fallback CDN
          const fallbackScript = document.createElement('script');
          fallbackScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js';
          fallbackScript.onload = function() {
            console.log('Socket.IO library loaded from fallback CDN');
          };
          fallbackScript.onerror = function() {
            console.error('All CDN sources failed - WebSocket features will not work');
            showSocketIOError();
          };
          document.head.appendChild(fallbackScript);
        };
        document.head.appendChild(script);
      }
      
      function showSocketIOError() {
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = 'position:fixed;top:0;left:0;right:0;background:#ef4444;color:white;padding:10px;text-align:center;z-index:9999;';
        errorDiv.innerHTML = '‚ö†Ô∏è WebSocket library failed to load - real-time features disabled. Check your internet connection.';
        document.body.appendChild(errorDiv);
      }
      
      // Load Socket.IO
      loadSocketIO();
      
      // Load MapLibre GL JS
      function loadMapLibre() {
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js';
        script.onload = function() {
          console.log('MapLibre GL JS library loaded');
        };
        script.onerror = function() {
          console.warn('Primary MapLibre CDN failed, trying fallback...');
          const fallbackScript = document.createElement('script');
          fallbackScript.src = 'https://cdn.jsdelivr.net/npm/maplibre-gl@3.6.2/dist/maplibre-gl.js';
          fallbackScript.onerror = function() {
            console.error('All MapLibre CDN sources failed - Map features will not work');
            showMapLibreError();
          };
          document.head.appendChild(fallbackScript);
        };
        document.head.appendChild(script);
        
        // Load MapLibre CSS
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css';
        link.onerror = function() {
          const fallbackLink = document.createElement('link');
          fallbackLink.rel = 'stylesheet';
          fallbackLink.href = 'https://cdn.jsdelivr.net/npm/maplibre-gl@3.6.2/dist/maplibre-gl.css';
          document.head.appendChild(fallbackLink);
        };
        document.head.appendChild(link);
      }
      
      function showMapLibreError() {
        const mapContainer = document.getElementById('map_container');
        if (mapContainer) {
          mapContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #ef4444; text-align: center; padding: 20px;"><div>‚ö†Ô∏è Map library failed to load<br><small>Check your internet connection</small></div></div>';
        }
      }
      
      // Load MapLibre
      loadMapLibre();
    </script>
    <script>
      // Simple check for Socket.IO availability
      window.addEventListener('load', function() {
        console.log('Page loaded, checking Socket.IO availability...');
        if (typeof io === 'undefined') {
          console.error('Socket.IO library failed to load from all CDN sources');
        } else {
          console.log('Socket.IO library is available');
        }
      });
    </script>
    <!-- Main application entry point -->
    <script type="module" src="/public/js/main.js"></script>
    <!-- Map functionality -->
    <script type="module" src="/public/js/map.js"></script>
  </body>
</html>


