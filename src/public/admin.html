<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TAK Lite Admin</title>
    <style>
      :root { --bg:#0b1220; --panel:#111a2b; --text:#e6edf3; --muted:#8b97a7; --accent:#3b82f6; --ok:#22c55e; --bad:#ef4444; }
      html,body { height:100%; }
      body { margin:0; background:linear-gradient(180deg,#0b1220,#0a0f1a); color:var(--text); font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; }
      .container { max-width:1100px; margin:0 auto; padding:24px; }
      header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
      .brand { font-weight:700; letter-spacing:.3px; }
      .version-separator { 
        margin: 0 8px; 
        color: var(--muted); 
        font-weight: 400; 
      }
      .version-text { 
        font-size: 12px; 
        color: var(--muted); 
        font-weight: 400; 
        letter-spacing: 0.5px;
      }
      .card { background:var(--panel); border:1px solid #1f2a44; border-radius:12px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
      .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:16px; }
      input,button { height:40px; border-radius:8px; border:1px solid #233153; background:#0c1527; color:var(--text); padding:0 12px; }
      input::placeholder { color:#6b7280; }
      button { background:linear-gradient(180deg,#2563eb,#1d4ed8); border:0; cursor:pointer; font-weight:600; }
      button.secondary { background:#0c1527; border:1px solid #223056; }
      .row { display:flex; gap:8px; align-items:center; }
      .section { margin-top:16px; }
      h2 { margin:0 0 8px; font-size:18px; color:#cbd5e1; }
      .kpi { display:flex; flex-direction: column; align-items:center; text-align: center; gap:8px; }
      .kpi .value { font-size:32px; font-weight:700; color: var(--accent); line-height: 1; }
      .kpi .label { font-size:12px; color: var(--muted); text-transform: uppercase; letter-spacing: 0.05em; font-weight: 500; }
      table { width:100%; border-collapse:collapse; font-size:14px; }
      th, td { border-bottom:1px solid #1f2a44; padding:10px; text-align:left; }
      .muted { color:var(--muted); }
      .pill { padding:2px 8px; border-radius:9999px; background:#0d1b34; border:1px solid #223056; font-size:12px; }
      .spacer { height:16px; }
      .right { text-align:right; }
      .hidden { display:none; }
      
      /* New styles for improved UX */
      .field-group { margin-bottom: 20px; }
      .field-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #cbd5e1; }
      .help-text { 
        background: #0d1b34; 
        border: 1px solid #223056; 
        border-radius: 6px; 
        padding: 12px; 
        margin-top: 8px; 
        font-size: 13px; 
        line-height: 1.4; 
        color: var(--muted);
      }
      .help-text strong { color: var(--text); }
      .message { 
        padding: 12px; 
        border-radius: 6px; 
        margin: 12px 0; 
        font-weight: 500;
        transition: opacity 0.3s ease;
      }
      .message-success { background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); color: #22c55e; }
      .message-error { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #ef4444; }
      .message-info { background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); color: #3b82f6; }
      .message.fade-out { opacity: 0; }
      .loading { opacity: 0.6; pointer-events: none; }
      .loading::after { content: '...'; }
      
      /* Improved Overview section */
      .overview-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
        margin-bottom: 20px;
      }
      
      .overview-stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
        margin-top: 16px;
      }
      
      .overview-stats .stat-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #1f2a44;
      }
      
      .overview-stats .stat-row:last-child {
        border-bottom: none;
      }
      
      .overview-stats .stat-label {
        color: var(--muted);
        font-size: 13px;
      }
      
      .overview-stats .stat-value {
        color: var(--text);
        font-weight: 500;
        font-family: 'Courier New', monospace;
      }
      
      /* Fixed input widths */
      .field-group input {
        width: 100%;
        box-sizing: border-box;
        max-width: 100%;
      }
      
      .row input {
        flex: 1;
        min-width: 0; /* Prevents flex items from overflowing */
      }
      
      /* Better spacing for configuration panel */
      .config-row {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
      }
      
      .config-row label {
        min-width: 120px;
        margin-bottom: 0;
        font-size: 14px;
      }
      
      .config-row input {
        flex: 1;
        min-width: 0;
      }
      
      /* Improved button styling */
      .save-button {
        margin-top: 20px;
        width: auto;
        padding: 10px 20px;
        float: right;
      }
      
      /* Better table styling */
      .users-table, .teams-table {
        margin-top: 16px;
        background: #0c1527;
        border-radius: 8px;
        overflow: hidden;
      }
      
      .users-table th, .teams-table th {
        background: #0d1b34;
        font-weight: 600;
        color: #cbd5e1;
        padding: 12px;
      }
      
      .users-table td, .teams-table td {
        padding: 12px;
        border-bottom: 1px solid #1f2a44;
      }
      
      /* Responsive improvements */
      @media (max-width: 768px) {
        .overview-grid {
          grid-template-columns: repeat(2, 1fr);
        }
        
        .overview-stats {
          grid-template-columns: 1fr;
        }
        
        .config-row {
          flex-direction: column;
          align-items: stretch;
        }
        
        .config-row label {
          min-width: auto;
        }
      }
      
      @media (max-width: 480px) {
        .overview-grid {
          grid-template-columns: 1fr;
        }
      }
      
      /* Enhanced popup styling (matching Android app) */
      .maplibregl-popup.enhanced-popup .maplibregl-popup-content {
        background: rgba(0, 0, 0, 0.8) !important;
        border: 1px solid rgba(255, 255, 255, 0.2) !important;
        border-radius: 12px !important;
        padding: 16px !important;
        min-width: 200px !important;
        max-width: 300px !important;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5) !important;
        font-family: ui-sans-serif, system-ui, -apple-system, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif !important;
      }
      
      .maplibregl-popup.enhanced-popup .maplibregl-popup-tip {
        border-top-color: rgba(0, 0, 0, 0.8) !important;
      }
      
      .maplibregl-popup.enhanced-popup .maplibregl-popup-close-button {
        color: #ffffff !important;
        font-size: 18px !important;
        font-weight: bold !important;
        right: 8px !important;
        top: 8px !important;
        width: 24px !important;
        height: 24px !important;
        line-height: 24px !important;
        text-align: center !important;
        border-radius: 50% !important;
        background: rgba(255, 255, 255, 0.1) !important;
        transition: background-color 0.2s ease !important;
      }
      
      .maplibregl-popup.enhanced-popup .maplibregl-popup-close-button:hover {
        background: rgba(255, 255, 255, 0.2) !important;
      }
      
      .popup-container {
        color: #ffffff;
        line-height: 1.4;
      }
      
      .popup-title {
        font-size: 16px;
        font-weight: bold;
        color: #ffffff;
        margin-bottom: 8px;
        text-align: center;
        word-wrap: break-word;
      }
      
      .popup-content {
        font-size: 14px;
        color: #ffffff;
        text-align: center;
        margin-bottom: 8px;
        line-height: 1.5;
        word-wrap: break-word;
      }
      
      .popup-status {
        font-size: 11px;
        font-style: italic;
        color: #ffffff;
        text-align: center;
        opacity: 0.8;
      }
      
      /* Full width overview section */
      .overview-full-width {
        width: 100%;
        margin-bottom: 16px;
        box-sizing: border-box;
      }
      
      .overview-full-width .overview-grid {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 16px;
        margin-bottom: 20px;
      }
      
      .overview-full-width .overview-stats {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
      }
      
      /* Responsive adjustments for full width overview */
      @media (max-width: 1200px) {
        .overview-full-width .overview-grid {
          grid-template-columns: repeat(4, 1fr);
        }
        
        .overview-full-width .overview-stats {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      
      @media (max-width: 768px) {
        .overview-full-width .overview-grid {
          grid-template-columns: repeat(2, 1fr);
        }
        
        .overview-full-width .overview-stats {
          grid-template-columns: 1fr;
        }
      }
      
      @media (max-width: 480px) {
        .overview-full-width .overview-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <div class="brand">
          TAK Lite Admin
          <span class="version-separator">|</span>
          <span id="header_version" class="version-text">-</span>
        </div>
        <div class="row">
          <span id="who" class="muted hidden"></span>
          <button id="logout" class="secondary hidden">Logout</button>
        </div>
      </header>

      <div id="loginCard" class="card">
        <h2>Sign in</h2>
        <div class="row">
          <input id="email" type="email" placeholder="admin@example.com" style="flex:1" />
          <input id="password" type="password" placeholder="password" style="flex:1" />
          <button id="login">Login</button>
        </div>
        <div id="loginMsg" class="message message-error hidden"></div>
      </div>

      <div id="dash" class="hidden">
        <!-- Global message area -->
        <div id="globalMessage" class="message hidden"></div>
        
        <!-- Full width Overview section -->
        <div class="card overview-full-width">
          <h2>Overview</h2>
          <div class="overview-grid">
            <div class="kpi">
              <span class="value" id="k_users">-</span>
              <span class="label">Users</span>
            </div>
            <div class="kpi">
              <span class="value" id="k_teams">-</span>
              <span class="label">Teams</span>
            </div>
            <div class="kpi">
              <span class="value" id="k_sockets">-</span>
              <span class="label">Sockets</span>
            </div>
            <div class="kpi">
              <span class="value" id="k_auth">-</span>
              <span class="label">Auth</span>
            </div>
            <div class="kpi">
              <span class="value" id="k_annotations">-</span>
              <span class="label">Annotations</span>
            </div>
            <div class="kpi">
              <span class="value" id="k_messages">-</span>
              <span class="label">Messages</span>
            </div>
            <div class="kpi">
              <span class="value" id="k_locations">-</span>
              <span class="label">Locations</span>
            </div>
            <div class="kpi">
              <span class="value" id="k_sync_status">-</span>
              <span class="label">Sync Status</span>
            </div>
          </div>
          
          <div class="overview-stats">
            <div class="stat-row">
              <span class="stat-label">Uptime</span>
              <span class="stat-value" id="k_uptime">-</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Node</span>
              <span class="stat-value" id="k_node">-</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Load / CPU</span>
              <span class="stat-value" id="k_load">-</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Memory</span>
              <span class="stat-value" id="k_mem">-</span>
            </div>
          </div>
        </div>

        <!-- Map section right under overview -->
        <div class="section card">
          <h2>Live Map View</h2>
          <div class="help-text">
            <strong>Real-time map</strong> showing annotations and peer locations from all teams
          </div>
          
          <div style="display: flex; gap: 12px; margin-bottom: 16px; align-items: center;">
            <select id="map_team_select" style="flex: 1; min-width: 200px;">
              <option value="">All Teams</option>
            </select>
            <button id="map_refresh" class="secondary">Refresh Data</button>
            <button id="map_center" class="secondary">Center Map</button>
            <div style="display: flex; gap: 8px; align-items: center;">
              <label style="display: flex; align-items: center; gap: 4px; font-size: 14px;">
                <input id="map_show_annotations" type="checkbox" checked />
                Annotations
              </label>
              <label style="display: flex; align-items: center; gap: 4px; font-size: 14px;">
                <input id="map_show_locations" type="checkbox" checked />
                Locations
              </label>
            </div>
          </div>
          
          <div id="map_container" style="height: 500px; border-radius: 8px; overflow: hidden; background: #0c1527; border: 1px solid #1f2a44;">
          </div>
          
          <div style="margin-top: 16px; font-size: 13px;">
            <strong>Map Controls:</strong>
            <div style="margin-top: 8px; color: var(--muted);">
              • Click and drag to pan<br>
              • Scroll to zoom<br>
              • Click annotations for details<br>
              • Use team filter to focus on specific teams
            </div>
          </div>
        </div>

        <!-- Real-time Activity and Configuration side by side -->
        <div class="grid" style="margin-top: 16px;">
          <div class="card">
            <h2>Real-time Activity</h2>
            <div class="help-text">
              <strong>Live updates</strong> of connected devices, sync activity, and system events
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin: 16px 0;">
              <div>
                <strong>WebSocket Status:</strong> 
                <span id="ws_status" style="color: #ef4444;">Disconnected</span>
              </div>
              <button id="reconnect_ws" class="secondary small">Reconnect WebSocket</button>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
              <div>
                <h3 style="margin: 0 0 8px; font-size: 14px; color: #cbd5e1;">Active Connections</h3>
                <pre id="rooms" class="muted" style="white-space:pre-wrap; margin:0; background: #0c1527; padding: 12px; border-radius: 6px; max-height: 150px; overflow-y: auto; font-size: 12px;"></pre>
              </div>
              <div>
                <h3 style="margin: 0 0 8px; font-size: 14px; color: #cbd5e1;">Recent Activity</h3>
                <div id="activity_log" style="background: #0c1527; padding: 12px; border-radius: 6px; max-height: 150px; overflow-y: auto; font-size: 12px; font-family: 'Courier New', monospace;">
                  <div class="muted">Waiting for activity...</div>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <h2>Configuration</h2>
            <div class="field-group">
              <label for="org">Organization Name</label>
              <input id="org" />
              <div class="help-text">
                <strong>Display name</strong> for your organization that appears in the TAK Lite app
              </div>
            </div>
            
            <div class="field-group">
              <label for="cors">Allowed Websites (CORS)</label>
              <input id="cors" placeholder="http://localhost:3000" />
              <div class="help-text">
                <strong>What is this?</strong> Controls which websites can connect to your server.<br>
                <strong>Leave blank</strong> if you're only using the TAK Lite mobile app.<br>
                <strong>Example:</strong> http://localhost:3000, https://myapp.com
              </div>
            </div>
            
            <div class="field-group">
              <label for="retention">Data Retention Period (days)</label>
              <input id="retention" type="number" min="0" max="365" />
              <div class="help-text">
                <strong>How long to keep:</strong> Location history, messages, and annotations<br>
                <strong>0 days:</strong> Keep everything forever (uses more storage)<br>
                <strong>30 days:</strong> Good balance for most teams<br>
                <strong>90+ days:</strong> For compliance or long-term projects
              </div>
            </div>
            
            <button id="save" class="secondary save-button">Save Changes</button>
            <div id="saveMsg" class="message hidden"></div>
          </div>
        </div>

        <!-- Message Monitoring Section -->
        <div class="section card" style="margin-top: 16px;">
          <h2>Live Message Monitoring</h2>
          <div class="help-text">
            <strong>Real-time message monitoring</strong> showing all team communications as they happen
          </div>
          
          <div style="display: flex; gap: 12px; margin-bottom: 16px; align-items: center;">
            <select id="message_team_filter" style="flex: 1; min-width: 200px;">
              <option value="">All Teams</option>
            </select>
            <button id="clear_messages" class="secondary">Clear Messages</button>
            <div style="display: flex; gap: 8px; align-items: center;">
              <label style="display: flex; align-items: center; gap: 4px; font-size: 14px;">
                <input id="message_auto_scroll" type="checkbox" checked />
                Auto-scroll
              </label>
              <label style="display: flex; align-items: center; gap: 4px; font-size: 14px;">
                <input id="message_show_timestamps" type="checkbox" checked />
                Show timestamps
              </label>
            </div>
          </div>
          
          <div id="message_monitor" style="height: 300px; border-radius: 8px; overflow: hidden; background: #0c1527; border: 1px solid #1f2a44; padding: 12px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 13px;">
            <div class="muted" style="text-align: center; padding: 20px;">Waiting for messages...</div>
          </div>
          
          <div style="margin-top: 16px; font-size: 13px;">
            <strong>Message Controls:</strong>
            <div style="margin-top: 8px; color: var(--muted);">
              • Messages appear in real-time as they are sent<br>
              • Use team filter to focus on specific teams<br>
              • Auto-scroll keeps the latest messages visible<br>
              • Messages are stored for the current session only
            </div>
          </div>
        </div>

        <div class="section grid" style="margin-top: 16px;">
          <div class="card">
            <h2>Users</h2>
            <div class="row">
              <input id="u_email" type="email" placeholder="user@example.com" />
              <input id="u_name" type="text" placeholder="Name" />
              <label class="row" style="gap:6px"><input id="u_admin" type="checkbox" /> Admin</label>
              <button id="u_create">Create User</button>
            </div>
            <div id="u_msg" class="message hidden"></div>
            <div class="users-table">
              <table id="u_table"><thead><tr><th>Email</th><th>Name</th><th>Admin</th><th>Actions</th></tr></thead><tbody></tbody></table>
            </div>
          </div>

          <div class="card">
            <h2>Teams</h2>
            <div class="row">
              <input id="t_name" type="text" placeholder="Team name" />
              <button id="t_create">Create Team</button>
            </div>
            <div class="row section">
              <select id="t_select" style="flex:1"></select>
              <select id="t_user_select" style="flex:1"></select>
              <button id="t_add_member">Add Member</button>
            </div>
            <div id="t_msg" class="message hidden"></div>
            <div class="teams-table">
              <table id="t_table"><thead><tr><th>User</th><th>Email</th><th>Actions</th></tr></thead><tbody></tbody></table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Load Socket.IO with CDN fallback
      function loadSocketIO() {
        const script = document.createElement('script');
        script.src = 'https://cdn.socket.io/4.7.2/socket.io.min.js';
        script.onload = function() {
          console.log('Socket.IO library loaded from primary CDN');
        };
        script.onerror = function() {
          console.warn('Primary CDN failed, trying fallback...');
          // Try fallback CDN
          const fallbackScript = document.createElement('script');
          fallbackScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js';
          fallbackScript.onload = function() {
            console.log('Socket.IO library loaded from fallback CDN');
          };
          fallbackScript.onerror = function() {
            console.error('All CDN sources failed - WebSocket features will not work');
            showSocketIOError();
          };
          document.head.appendChild(fallbackScript);
        };
        document.head.appendChild(script);
      }
      
      function showSocketIOError() {
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = 'position:fixed;top:0;left:0;right:0;background:#ef4444;color:white;padding:10px;text-align:center;z-index:9999;';
        errorDiv.innerHTML = '⚠️ WebSocket library failed to load - real-time features disabled. Check your internet connection.';
        document.body.appendChild(errorDiv);
      }
      
      // Load Socket.IO
      loadSocketIO();
      
      // Load MapLibre GL JS
      function loadMapLibre() {
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js';
        script.onload = function() {
          console.log('MapLibre GL JS library loaded');
        };
        script.onerror = function() {
          console.warn('Primary MapLibre CDN failed, trying fallback...');
          const fallbackScript = document.createElement('script');
          fallbackScript.src = 'https://cdn.jsdelivr.net/npm/maplibre-gl@3.6.2/dist/maplibre-gl.js';
          fallbackScript.onerror = function() {
            console.error('All MapLibre CDN sources failed - Map features will not work');
            showMapLibreError();
          };
          document.head.appendChild(fallbackScript);
        };
        document.head.appendChild(script);
        
        // Load MapLibre CSS
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css';
        link.onerror = function() {
          const fallbackLink = document.createElement('link');
          fallbackLink.rel = 'stylesheet';
          fallbackLink.href = 'https://cdn.jsdelivr.net/npm/maplibre-gl@3.6.2/dist/maplibre-gl.css';
          document.head.appendChild(fallbackLink);
        };
        document.head.appendChild(link);
      }
      
      function showMapLibreError() {
        const mapContainer = document.getElementById('map_container');
        if (mapContainer) {
          mapContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #ef4444; text-align: center; padding: 20px;"><div>⚠️ Map library failed to load<br><small>Check your internet connection</small></div></div>';
        }
      }
      
      // Load MapLibre
      loadMapLibre();
    </script>
    <script>
      // Simple check for Socket.IO availability
      window.addEventListener('load', function() {
        console.log('Page loaded, checking Socket.IO availability...');
        if (typeof io === 'undefined') {
          console.error('Socket.IO library failed to load from all CDN sources');
        } else {
          console.log('Socket.IO library is available');
        }
      });
    </script>
    <script src="/public/js/admin.js"></script>
    <script src="/public/js/map.js"></script>
  </body>
</html>


