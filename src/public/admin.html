<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TAK Lite Admin</title>
    <link rel="stylesheet" href="/public/css/variables.css" />
    <link rel="stylesheet" href="/public/css/base.css" />
    <link rel="stylesheet" href="/public/css/components.css" />
    <link rel="stylesheet" href="/public/css/pages/admin.css" />
  </head>
  <body>
    <div class="container">
      <header>
        <div class="brand">
          TAK Lite Admin
          <span class="version-separator">|</span>
          <span id="header_version" class="version-text">-</span>
        </div>
        <div class="row">
          <span id="who" class="muted hidden"></span>
          <button id="logout" class="secondary hidden">Logout</button>
        </div>
      </header>

      <!-- Navigation -->
      <nav id="adminNav" class="hidden" style="margin-bottom: 20px;">
        <div class="card" style="padding: 12px 16px;">
          <div style="display: flex; gap: 16px; align-items: center; flex-wrap: wrap;">
            <a href="#" id="nav-dashboard" style="color: var(--text); text-decoration: none; padding: 8px 12px; border-radius: 6px; background: var(--accent); font-weight: 500; cursor: pointer;">Dashboard</a>
            <a href="#" id="nav-threats" style="color: var(--muted); text-decoration: none; padding: 8px 12px; border-radius: 6px; transition: all 0.2s; cursor: pointer;">Threat Review</a>
            <a href="#" id="nav-messages" style="color: var(--muted); text-decoration: none; padding: 8px 12px; border-radius: 6px; transition: all 0.2s; cursor: pointer;">Messages</a>
            <a href="#" id="nav-settings" style="color: var(--muted); text-decoration: none; padding: 8px 12px; border-radius: 6px; transition: all 0.2s; cursor: pointer;">Settings</a>
            <a href="#" id="nav-management" style="color: var(--muted); text-decoration: none; padding: 8px 12px; border-radius: 6px; transition: all 0.2s; cursor: pointer;">Management</a>
            <a href="/social-media" id="nav-social" style="color: var(--muted); text-decoration: none; padding: 8px 12px; border-radius: 6px; transition: all 0.2s;">Social Media</a>
          </div>
        </div>
      </nav>

      <div id="loginCard" class="card">
        <h2>Sign in</h2>
        <div class="row">
          <input id="email" type="email" placeholder="admin@example.com" style="flex:1" />
          <input id="password" type="password" placeholder="password" style="flex:1" />
          <button id="login">Login</button>
        </div>
        <div id="loginMsg" class="message message-error hidden"></div>
      </div>

      <!-- Settings Page -->
      <div id="settingsPage" class="hidden">
        <div class="card">
          <h2>Settings</h2>
          <div class="help-text">
            <strong>Server configuration</strong> for organization settings, security, and data retention
          </div>
          
          <div class="field-group">
            <label for="org">Organization Name</label>
            <input id="org" />
            <div class="help-text">
              <strong>Display name</strong> for your organization that appears in the TAK Lite app
            </div>
          </div>
          
          <div class="field-group">
            <label for="cors">Allowed Websites (CORS)</label>
            <input id="cors" placeholder="http://localhost:3000" />
            <div class="help-text">
              <strong>What is this?</strong> Controls which websites can connect to your server.<br>
              <strong>Leave blank</strong> if you're only using the TAK Lite mobile app.<br>
              <strong>Example:</strong> http://localhost:3000, https://myapp.com
            </div>
          </div>
          
          <div class="field-group">
            <label for="retention">Data Retention Period (days)</label>
            <input id="retention" type="number" min="0" max="365" />
            <div class="help-text">
              <strong>How long to keep:</strong> Location history, messages, and annotations<br>
              <strong>0 days:</strong> Keep everything forever (uses more storage)<br>
              <strong>30 days:</strong> Good balance for most teams<br>
              <strong>90+ days:</strong> For compliance or long-term projects
            </div>
          </div>
          
          <button id="save" class="secondary save-button">Save Changes</button>
          <div id="saveMsg" class="message hidden"></div>
        </div>
      </div>

      <!-- Management Page -->
      <div id="managementPage" class="hidden">
        <div class="grid">
          <div class="card">
            <h2>Users</h2>
            <div class="row">
              <input id="u_email" type="email" placeholder="user@example.com" />
              <input id="u_name" type="text" placeholder="Name" />
              <label class="row" style="gap:6px"><input id="u_admin" type="checkbox" /> Admin</label>
              <button id="u_create">Create User</button>
            </div>
            <div id="u_msg" class="message hidden"></div>
            <div class="users-table">
              <table id="u_table"><thead><tr><th>Email</th><th>Name</th><th>Admin</th><th>Actions</th></tr></thead><tbody></tbody></table>
            </div>
          </div>

          <div class="card">
            <h2>Teams</h2>
            <div class="row">
              <input id="t_name" type="text" placeholder="Team name" />
              <button id="t_create">Create Team</button>
            </div>
            <div class="row section">
              <select id="t_select" style="flex:1"></select>
              <select id="t_user_select" style="flex:1"></select>
              <button id="t_add_member">Add Member</button>
            </div>
            <div id="t_msg" class="message hidden"></div>
            <div class="teams-table">
              <table id="t_table"><thead><tr><th>User</th><th>Email</th><th>Actions</th></tr></thead><tbody></tbody></table>
            </div>
          </div>
        </div>
      </div>

      <!-- Threat Review Page -->
      <div id="threatsPage" class="hidden">
        <div class="card">
          <h2>AI Threat Review</h2>
          <div class="help-text">
            <strong>Review and manage AI-detected threats</strong> from geographical monitoring and social media analysis
          </div>
          
          <div style="display: flex; gap: 12px; margin-bottom: 16px; align-items: center;">
            <select id="threat_status_filter" style="flex: 1; min-width: 150px;">
              <option value="pending">Pending Review</option>
              <option value="reviewed">Reviewed</option>
              <option value="approved">Approved</option>
              <option value="dismissed">Dismissed</option>
              <option value="all">All Threats</option>
            </select>
            <select id="threat_level_filter" style="flex: 1; min-width: 150px;">
              <option value="">All Levels</option>
              <option value="LOW">Low</option>
              <option value="MEDIUM">Medium</option>
              <option value="HIGH">High</option>
              <option value="CRITICAL">Critical</option>
            </select>
            <button id="refresh_threats" class="secondary">Refresh</button>
            <div style="display: flex; gap: 8px; align-items: center;">
              <label style="display: flex; align-items: center; gap: 4px; font-size: 14px;">
                <input id="threat_auto_refresh" type="checkbox" checked />
                Auto-refresh
              </label>
            </div>
          </div>
          
          <div id="threats_list" style="max-height: 600px; overflow-y: auto; border: 1px solid #1f2a44; border-radius: 8px; background: #0c1527;">
            <div class="muted" style="text-align: center; padding: 20px;">Loading threats...</div>
          </div>
          
          <div style="margin-top: 16px; font-size: 13px;">
            <strong>Threat Review Controls:</strong>
            <div style="margin-top: 8px; color: var(--muted);">
              • Review AI-detected threats and their confidence scores<br>
              • Approve threats to create map annotations for teams<br>
              • Dismiss false positives or irrelevant threats<br>
              • Real-time notifications for new threats appear here
            </div>
          </div>
        </div>
      </div>

      <!-- Messages Page -->
      <div id="messagesPage" class="hidden">
        <div class="card">
          <h2>Live Message Monitoring</h2>
          <div class="help-text">
            <strong>Real-time message monitoring</strong> showing all team communications as they happen
          </div>
          
          <div style="display: flex; gap: 12px; margin-bottom: 16px; align-items: center;">
            <select id="message_team_filter" style="flex: 1; min-width: 200px;">
              <option value="">All Teams</option>
            </select>
            <button id="clear_messages" class="secondary">Clear Messages</button>
            <div style="display: flex; gap: 8px; align-items: center;">
              <label style="display: flex; align-items: center; gap: 4px; font-size: 14px;">
                <input id="message_auto_scroll" type="checkbox" checked />
                Auto-scroll
              </label>
              <label style="display: flex; align-items: center; gap: 4px; font-size: 14px;">
                <input id="message_show_timestamps" type="checkbox" checked />
                Show timestamps
              </label>
            </div>
          </div>
          
          <div id="message_monitor" style="height: 600px; border-radius: 8px; overflow: hidden; background: #0c1527; border: 1px solid #1f2a44; padding: 12px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 13px;">
            <div class="muted" style="text-align: center; padding: 20px;">Waiting for messages...</div>
          </div>
          
          <div style="margin-top: 16px; font-size: 13px;">
            <strong>Message Controls:</strong>
            <div style="margin-top: 8px; color: var(--muted);">
              • Messages appear in real-time as they are sent<br>
              • Use team filter to focus on specific teams<br>
              • Auto-scroll keeps the latest messages visible<br>
              • Messages are stored for the current session only
            </div>
          </div>
        </div>
      </div>

      <!-- Dashboard Page -->
      <div id="dash" class="hidden">
        <!-- Global message area -->
        <div id="globalMessage" class="message hidden"></div>
        
        <!-- Operational Status Bar (Field Operations Focus) -->
        <div class="card" style="margin-bottom: 16px; padding: 12px 16px;">
          <div class="operational-status-bar">
            <div class="status-item">
              <span class="status-label">Active Users:</span>
              <span class="status-value" id="k_users">-</span>
            </div>
            <div class="status-item">
              <span class="status-label">Active Teams:</span>
              <span class="status-value" id="k_teams">-</span>
            </div>
            <div class="status-item">
              <span class="status-label">Sync Status:</span>
              <span class="status-value" id="k_sync_status" style="color: #8b97a7;">-</span>
            </div>
            <div class="status-item">
              <span class="status-label">Connection:</span>
              <span class="status-value" id="ws_status" style="color: #ef4444;">Disconnected</span>
            </div>
            <div class="status-item">
              <span class="status-label">Active Threats:</span>
              <span class="status-value" id="k_active_threats">0</span>
            </div>
            <div class="status-item">
              <span class="status-label">Recent Messages:</span>
              <span class="status-value" id="k_recent_messages">0</span>
            </div>
          </div>
        </div>

        <!-- Main Dashboard Layout: Map (60%) + Side Panels (40%) -->
        <div class="dashboard-main-layout">
          <!-- Left Side: Map (60%) -->
          <div class="dashboard-map-section">
            <div class="card">
              <h2>Live Map View</h2>
              <div class="help-text">
                <strong>Real-time map</strong> showing annotations and peer locations from all teams
              </div>
              
              <div style="display: flex; gap: 12px; margin-bottom: 16px; align-items: center; flex-wrap: wrap;">
                <select id="map_team_select" style="flex: 1; min-width: 200px;">
                  <option value="">All Teams</option>
                </select>
                <button id="map_refresh" class="secondary">Refresh Data</button>
                <button id="map_center" class="secondary">Center Map</button>
                <button id="map_clear_all" class="secondary" style="background: #E91E63; color: white;">Clear All</button>
                <div style="display: flex; gap: 8px; align-items: center;">
                  <label style="display: flex; align-items: center; gap: 4px; font-size: 14px;">
                    <input id="map_show_annotations" type="checkbox" checked />
                    Annotations
                  </label>
                  <label style="display: flex; align-items: center; gap: 4px; font-size: 14px;">
                    <input id="map_show_locations" type="checkbox" checked />
                    Locations
                  </label>
                </div>
              </div>
              
              <div id="map_container" style="height: 600px; border-radius: 8px; overflow: hidden; background: #0c1527; border: 1px solid #1f2a44; position: relative;">
                <!-- Fan Menu for Annotation Creation -->
                <div id="fan_menu" class="fan-menu">
                  <!-- Center hole with dot and coordinate text -->
                  <div class="fan-menu-center">
                    <div class="fan-menu-center-dot"></div>
                    <div class="fan-menu-center-text fan-menu-center-coords" id="fan_menu_coords">0.00000, 0.00000</div>
                    <div class="fan-menu-center-text fan-menu-center-distance" id="fan_menu_distance">0.0 mi away</div>
                  </div>
                  <!-- Donut ring segments will be dynamically added here -->
                </div>
                
                <!-- Color Menu for Annotation Creation -->
                <div id="color_menu" class="color-menu">
                  <!-- Color options will be dynamically added here -->
                </div>
                
                <!-- Map Interaction Feedback -->
                <div id="map_feedback" class="map-interaction-feedback">
                  <!-- Feedback messages will be shown here -->
                </div>
              </div>
              
              <div style="margin-top: 12px; font-size: 12px; color: var(--muted);">
                <strong>Controls:</strong> Click and drag to pan • Scroll to zoom • <strong>Long press</strong> to create annotations • <strong>Right-click</strong> to edit/delete
              </div>
            </div>
          </div>

          <!-- Right Side: Side Panels (40%) -->
          <div class="dashboard-side-panels">
            <!-- Top Panel: Active Threats -->
            <div class="card" style="margin-bottom: 16px;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h2 style="margin: 0;">Active Threats</h2>
                <a href="#" id="view-all-threats" style="color: var(--accent); text-decoration: none; font-size: 12px; font-weight: 500; cursor: pointer;">View All →</a>
              </div>
              <div class="help-text" style="margin-bottom: 12px; font-size: 12px;">
                <strong>Critical & High</strong> threats requiring immediate attention
              </div>
              
              <div id="active_threats_panel" style="max-height: 300px; overflow-y: auto;">
                <div class="muted" style="text-align: center; padding: 20px; font-size: 13px;">Loading threats...</div>
              </div>
            </div>

            <!-- Bottom Panel: Live Messages -->
            <div class="card">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                <h2 style="margin: 0;">Live Messages</h2>
                <a href="#" id="view-all-messages" style="color: var(--accent); text-decoration: none; font-size: 12px; font-weight: 500; cursor: pointer;">View All →</a>
              </div>
              <div style="display: flex; gap: 8px; margin-bottom: 12px; align-items: center;">
                <select id="message_team_filter_compact" style="flex: 1; font-size: 12px; padding: 6px;">
                  <option value="">All Teams</option>
                </select>
                <button id="clear_messages_compact" class="secondary" style="padding: 6px 12px; font-size: 12px;">Clear</button>
              </div>
              
              <div id="message_monitor_compact" style="height: 300px; border-radius: 8px; overflow: hidden; background: #0c1527; border: 1px solid #1f2a44; padding: 12px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 12px;">
                <div class="muted" style="text-align: center; padding: 20px;">Waiting for messages...</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Overlay for Forms -->
    <div id="modal_overlay" class="modal-overlay"></div>
    
    <!-- Annotation Edit Form -->
    <div id="annotation_edit_form" class="annotation-edit-form" style="display: none;">
      <h3 id="edit_form_title">Edit Annotation</h3>
      <form id="edit_annotation_form">
        <div class="form-group">
          <label for="edit_label">Label</label>
          <input type="text" id="edit_label" name="label" placeholder="Enter annotation label">
        </div>
        
        <div class="form-group">
          <label for="edit_color">Color</label>
          <select id="edit_color" name="color">
            <option value="green">Green</option>
            <option value="yellow">Yellow</option>
            <option value="red">Red</option>
            <option value="black">Black</option>
            <option value="white">White</option>
          </select>
        </div>
        
        <div class="form-group" id="edit_shape_group" style="display: none;">
          <label for="edit_shape">Shape</label>
          <select id="edit_shape" name="shape">
            <option value="circle">Circle</option>
            <option value="square">Square</option>
            <option value="triangle">Triangle</option>
            <option value="exclamation">Exclamation</option>
          </select>
        </div>
        
        <div class="form-group" id="edit_radius_group" style="display: none;">
          <label for="edit_radius">Radius (meters)</label>
          <input type="number" id="edit_radius" name="radius" min="1" max="10000" step="1">
        </div>
        
        <div class="form-actions">
          <button type="button" id="edit_cancel" class="btn-secondary">Cancel</button>
          <button type="button" id="edit_delete" class="btn-secondary" style="background: #E91E63; color: white;">Delete</button>
          <button type="submit" id="edit_save" class="btn-primary">Save Changes</button>
        </div>
      </form>
    </div>

    <script>
      // Load Socket.IO with CDN fallback
      function loadSocketIO() {
        const script = document.createElement('script');
        script.src = 'https://cdn.socket.io/4.7.2/socket.io.min.js';
        script.onload = function() {
          console.log('Socket.IO library loaded from primary CDN');
        };
        script.onerror = function() {
          console.warn('Primary CDN failed, trying fallback...');
          // Try fallback CDN
          const fallbackScript = document.createElement('script');
          fallbackScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js';
          fallbackScript.onload = function() {
            console.log('Socket.IO library loaded from fallback CDN');
          };
          fallbackScript.onerror = function() {
            console.error('All CDN sources failed - WebSocket features will not work');
            showSocketIOError();
          };
          document.head.appendChild(fallbackScript);
        };
        document.head.appendChild(script);
      }
      
      function showSocketIOError() {
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = 'position:fixed;top:0;left:0;right:0;background:#ef4444;color:white;padding:10px;text-align:center;z-index:9999;';
        errorDiv.innerHTML = '⚠️ WebSocket library failed to load - real-time features disabled. Check your internet connection.';
        document.body.appendChild(errorDiv);
      }
      
      // Load Socket.IO
      loadSocketIO();
      
      // Load MapLibre GL JS
      function loadMapLibre() {
        const script = document.createElement('script');
        script.src = 'https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js';
        script.onload = function() {
          console.log('MapLibre GL JS library loaded');
        };
        script.onerror = function() {
          console.warn('Primary MapLibre CDN failed, trying fallback...');
          const fallbackScript = document.createElement('script');
          fallbackScript.src = 'https://cdn.jsdelivr.net/npm/maplibre-gl@3.6.2/dist/maplibre-gl.js';
          fallbackScript.onerror = function() {
            console.error('All MapLibre CDN sources failed - Map features will not work');
            showMapLibreError();
          };
          document.head.appendChild(fallbackScript);
        };
        document.head.appendChild(script);
        
        // Load MapLibre CSS
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css';
        link.onerror = function() {
          const fallbackLink = document.createElement('link');
          fallbackLink.rel = 'stylesheet';
          fallbackLink.href = 'https://cdn.jsdelivr.net/npm/maplibre-gl@3.6.2/dist/maplibre-gl.css';
          document.head.appendChild(fallbackLink);
        };
        document.head.appendChild(link);
      }
      
      function showMapLibreError() {
        const mapContainer = document.getElementById('map_container');
        if (mapContainer) {
          mapContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #ef4444; text-align: center; padding: 20px;"><div>⚠️ Map library failed to load<br><small>Check your internet connection</small></div></div>';
        }
      }
      
      // Load MapLibre
      loadMapLibre();
    </script>
    <script>
      // Simple check for Socket.IO availability
      window.addEventListener('load', function() {
        console.log('Page loaded, checking Socket.IO availability...');
        if (typeof io === 'undefined') {
          console.error('Socket.IO library failed to load from all CDN sources');
        } else {
          console.log('Socket.IO library is available');
        }
      });
    </script>
    <!-- Main application entry point -->
    <script type="module" src="/public/js/main.js"></script>
    <!-- Map functionality -->
    <script type="module" src="/public/js/map.js"></script>
  </body>
</html>


